<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>HFCTF2022 RE | devoke's blog</title><meta name="author" content="devoke"><meta name="copyright" content="devoke"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="the_shellcode不算太难的一道题，手快拿了个一血x。 Dump使用Exeinfo PE查壳发现程序加了Themida壳，不能直接静态分析，调试器附加也会有一些反调试的措施。 1Themida &amp;#x2F; Winlicense v3.0.0.0 - 3.0.8.0 - Oreans Technolo"><link rel="shortcut icon" href="https://s2.loli.net/2024/02/20/B6y8wIH5iltGxP9.png"><link rel="canonical" href="http://example.com/2022/03/20/WriteUp/HFCTF2022-RE/index.html"><link rel="preconnect"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/"><link rel="stylesheet" href="/" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: '/',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: ,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'HFCTF2022 RE',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: false,
  postUpdate: '2024-02-20 10:02:09'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://s2.loli.net/2024/05/04/Zav4zFVukLJMBKI.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">19</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">17</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">2</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://s2.loli.net/2024/02/20/h3iOcSdRqel45vD.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="devoke's blog"><span class="site-name">devoke's blog</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">HFCTF2022 RE</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-03-20T12:04:53.000Z" title="发表于 2022-03-20 20:04:53">2022-03-20</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-02-20T02:02:09.000Z" title="更新于 2024-02-20 10:02:09">2024-02-20</time></span></div><div class="meta-secondline"></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="the-shellcode"><a href="#the-shellcode" class="headerlink" title="the_shellcode"></a>the_shellcode</h2><p>不算太难的一道题，手快拿了个一血x。</p>
<h3 id="Dump"><a href="#Dump" class="headerlink" title="Dump"></a>Dump</h3><p>使用<code>Exeinfo PE</code>查壳发现程序加了Themida壳，不能直接静态分析，调试器附加也会有一些反调试的措施。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Themida / Winlicense v3.0.0.0 - 3.0.8.0 - Oreans Technologies - www.oreans.com</span><br></pre></td></tr></table></figure>

<p>对于反调试我们可以使用<code>ScyllaHide</code>插件来绕过，推荐使用<a target="_blank" rel="noopener" href="https://www.52pojie.cn/thread-1180667-1-1.html">iTruth整合版x64dbg(最新中文版) 内置配色方案+插件 - 『逆向资源区』 - 吾爱破解 - LCG - LSG |安卓破解|病毒分析|www.52pojie.cn</a>。</p>
<p>当程序运行到要求输入shellcode时，程序会挂起，内置的代码也基本解密完成，我们可以把此时的内存DUMP下来进行静态分析。</p>
<p>通过字符串引用我们可以定位到<code>main</code>函数，并获得OEP，然后就可以通过<code>Scylla</code>插件来Dump并修复IAT了。</p>
<p><img src="https://s2.loli.net/2022/03/20/6URMzuIj5r9Osmc.png" alt="image-20220320171810404"></p>
<p>得到Dump，就可以通过IDA静态分析了，结合x64dbg动态调试，可以知道程序大致的流程。</p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>Step1 获取输入并进行base64解码</p>
<p>Step2 对解码后的数据进行逐字节ROL3</p>
<p><img src="https://s2.loli.net/2022/03/20/4pTukSNt8EKaWLz.png" alt="image-20220320172119991"></p>
<p>Step3 XXTEA解密，通过常数<code>0x61C88647</code>可以判断，<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/4272e0805da3">TEA、XTEA、XXTEA加密解密算法 - 简书 (jianshu.com)</a>，对照发现修改了一些算法,从<code>z&gt;&gt;5</code> 变成了 <code>z&gt;&gt;6</code>,写解密算法时要注意。</p>
<p><img src="https://s2.loli.net/2022/03/20/o6B3TmCsIb4rLEh.png" alt="image-20220320172145534"></p>
<p>Step4 把加密过的shellcode与密文比对</p>
<p>Step5 比对通过，要求我们输入flag，并为shellcode进行内存分配等操作，最后通过<code>v28(printf,&amp;flag)</code>执行shellcode。</p>
<p><img src="https://s2.loli.net/2022/03/20/mfDpXK9sG1RZjJB.png" alt="image-20220320172505121"></p>
<p>Step6 通过动态调试（在储存flag的内存下断点）跟到shellcode执行处，然后就可以把shellcode Dump下来进行静态分析。</p>
<p><img src="https://s2.loli.net/2022/03/20/Mo8JgZNhjvPf9kW.png" alt="image-20220320174720230"></p>
<p>通过搜索常数<code>0x726774C</code>可以找到相关文章，<a target="_blank" rel="noopener" href="https://blog.csdn.net/jazrynwong/article/details/114380796">从meterpreter工作原理到免杀方式的分析_jazrynwong的博客-CSDN博客_meterpreter免杀</a>，对照着分析shellcode的流程，大概是通过遍历导出函数表比对hash找到函数<code>LoadLibraryExA</code>，然后通过<code>ModuleBase+0x50</code>获得一个字符串，即下图EDX指向的位置。</p>
<p><img src="https://s2.loli.net/2022/03/20/SC2wvV5rWlc8eYp.png" alt="image-20220319175634344"></p>
<p>Step7  计算 字符串<code>&#39;is program cannot be run in Dos mode.\&quot;</code>的hash，然后用另一种方式计算我们输入的flag的hash，比对成功则<code>printf(&quot;yes&quot;)</code>,显然两个计算方式的差异只有 后者多了一个 <code>-fun_name_ptr[i] % 5</code> ,要想获得相同的hash，只要满足<code>Str1[i] == flag[i] - fun_name_ptr[i] %5</code> 即可，动调一下发现<code>fun_name_ptr</code>就是<code>LoadLibraryExA</code>。</p>
<p><img src="https://s2.loli.net/2022/03/20/FI2R87ac4NsEXvK.png" alt="image-20220320174704631"></p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DELTA 0x9e3779b9  </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MX (((z&gt;&gt;6^y<span class="string">&lt;&lt;2) + (y&gt;</span>&gt;3^z&lt;&lt;4)) ^ ((sum^y) + (key[(p&amp;3)^e] ^ z)))  </span></span><br><span class="line">  </span><br><span class="line"><span class="type">void</span> <span class="title function_">btea</span><span class="params">(<span class="type">uint32_t</span> *v, <span class="type">int</span> n, <span class="type">uint32_t</span> <span class="type">const</span> key[<span class="number">4</span>])</span>  </span><br><span class="line">&#123;  </span><br><span class="line">    <span class="type">uint32_t</span> y, z, sum;  </span><br><span class="line">    <span class="type">unsigned</span> p, rounds, e;  </span><br><span class="line">    <span class="keyword">if</span> (n &gt; <span class="number">1</span>)            <span class="comment">/* Coding Part */</span>  </span><br><span class="line">    &#123;  </span><br><span class="line">        rounds = <span class="number">6</span> + <span class="number">52</span>/n;  </span><br><span class="line">        sum = <span class="number">0</span>;  </span><br><span class="line">        z = v[n<span class="number">-1</span>];  </span><br><span class="line">        <span class="keyword">do</span>  </span><br><span class="line">        &#123;  </span><br><span class="line">            sum += DELTA;  </span><br><span class="line">            e = (sum &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>;  </span><br><span class="line">            <span class="keyword">for</span> (p=<span class="number">0</span>; p&lt;n<span class="number">-1</span>; p++)  </span><br><span class="line">            &#123;  </span><br><span class="line">                y = v[p+<span class="number">1</span>];  </span><br><span class="line">                z = v[p] += MX;  </span><br><span class="line">            &#125;  </span><br><span class="line">            y = v[<span class="number">0</span>];  </span><br><span class="line">            z = v[n<span class="number">-1</span>] += MX;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">while</span> (--rounds);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (n &lt; <span class="number">-1</span>)      <span class="comment">/* Decoding Part */</span>  </span><br><span class="line">    &#123;  </span><br><span class="line">        n = -n;  </span><br><span class="line">        rounds = <span class="number">6</span> + <span class="number">52</span>/n;  </span><br><span class="line">        sum = rounds*DELTA;  </span><br><span class="line">        y = v[<span class="number">0</span>];  </span><br><span class="line">        <span class="keyword">do</span>  </span><br><span class="line">        &#123;  </span><br><span class="line">            e = (sum &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>;  </span><br><span class="line">            <span class="keyword">for</span> (p=n<span class="number">-1</span>; p&gt;<span class="number">0</span>; p--)  </span><br><span class="line">            &#123;  </span><br><span class="line">                z = v[p<span class="number">-1</span>];  </span><br><span class="line">                y = v[p] -= MX;  </span><br><span class="line">            &#125;  </span><br><span class="line">            z = v[n<span class="number">-1</span>];  </span><br><span class="line">            y = v[<span class="number">0</span>] -= MX;  </span><br><span class="line">            sum -= DELTA;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">while</span> (--rounds);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="type">void</span> <span class="title function_">print_arr</span><span class="params">(<span class="type">uint32_t</span> *v, <span class="type">int</span> n)</span>  </span><br><span class="line">&#123;  </span><br><span class="line">    <span class="type">int</span> i;  </span><br><span class="line">    <span class="type">int</span> line = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;n; i++)  </span><br><span class="line">     &#123;  <span class="built_in">printf</span>(<span class="string">&quot;%08X &quot;</span>, v[i]);  </span><br><span class="line">        line++;</span><br><span class="line">        <span class="keyword">if</span>(line == <span class="number">4</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            line = <span class="number">0</span>;</span><br><span class="line">        &#125;&#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">ror</span><span class="params">(<span class="type">uint8_t</span>* data, <span class="type">int</span> len, <span class="type">int</span> ror_num)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="type">uint8_t</span> tmp;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;len; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        tmp = data[i];</span><br><span class="line">        data[i] = (tmp &gt;&gt; ror_num) | (tmp &lt;&lt; (<span class="number">8</span>-ror_num));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>  </span><br><span class="line">&#123;  </span><br><span class="line">    <span class="type">uint32_t</span> sc_cipher[<span class="number">66</span>] = &#123;<span class="number">0x4B6B89A1</span>,<span class="number">0x74C15453</span>,<span class="number">0x4092A06E</span>,<span class="number">0x429B0C07</span>,<span class="number">0x40281E84</span>,<span class="number">0x8B5B44C9</span>,<span class="number">0x66FEB37B</span>,<span class="number">0x3C77A603</span>,<span class="number">0x79C5892D</span>,<span class="number">0x0D7ADA97</span>,<span class="number">0x1D51AA56</span>,<span class="number">0x2D4D703</span>,<span class="number">0x4FA526BA</span>,<span class="number">0x32FAD64A</span>,<span class="number">0x0C0F6091</span>,<span class="number">0x562B7593</span>,<span class="number">0x0DB9ADD67</span>,<span class="number">0x76165563</span>,<span class="number">0x0A5F79315</span>,<span class="number">0x3AEB991D</span>,<span class="number">0x1AB721D4</span>,<span class="number">0x0AACD9D2C</span>,<span class="number">0x825C2B27</span>,<span class="number">0x76A7761A</span>,<span class="number">0x0B4005F18</span>,<span class="number">0x117F3763</span>,<span class="number">0x512CC540</span>,<span class="number">0x0C594A16F</span>,<span class="number">0x0D0E24F8C</span>,<span class="number">0x9CA3E2E9</span>,<span class="number">0x0A9CC2D5</span>,<span class="number">0x4629E61D</span>,<span class="number">0x637129E3</span>,<span class="number">0x0CA4E8AD7</span>,<span class="number">0x0F5DFAF71</span>,<span class="number">0x474E68AB</span>,<span class="number">0x542FBC3A</span>,<span class="number">0x0D6741617</span>,<span class="number">0x0AD0DBBE5</span>,<span class="number">0x62F7BBE3</span>,<span class="number">0x0C8D68C07</span>,<span class="number">0x880E950E</span>,<span class="number">0x0F80F25BA</span>,<span class="number">0x767A264C</span>,<span class="number">0x9A7CE014</span>,<span class="number">0x5C8BC9EE</span>,<span class="number">0x5D9EF7D4</span>,<span class="number">0x0B999ACDE</span>,<span class="number">0x0B2EC8E13</span>,<span class="number">0x0EE68232D</span>,<span class="number">0x927C5FCE</span>,<span class="number">0x0C9E3A85D</span>,<span class="number">0x0AC74B56B</span>,<span class="number">0x42B6E712</span>,<span class="number">0x0CD2898DA</span>,<span class="number">0x0FCF11C58</span>,<span class="number">0x0F57075EE</span>,<span class="number">0x5076E678</span>,<span class="number">0x0D4D66A35</span>,<span class="number">0x95105AB9</span>,<span class="number">0x1BB04403</span>,<span class="number">0x0B240B959</span>,<span class="number">0x7B4E261A</span>,<span class="number">0x23D129D8</span>,<span class="number">0x0F5E752CD</span>,<span class="number">0x4EA78F70</span>&#125;;</span><br><span class="line">    <span class="type">uint32_t</span> <span class="type">const</span> k[<span class="number">4</span>]= &#123;<span class="number">116</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">97</span>&#125;;  </span><br><span class="line">    <span class="type">int</span> n= <span class="number">66</span>; <span class="comment">//n的绝对值表示v的长度，取正表示加密，取负表示解密  </span></span><br><span class="line">    <span class="comment">// v为要加密的数据是两个32位无符号整数  </span></span><br><span class="line">    <span class="comment">// k为加密解密密钥，为4个32位无符号整数，即密钥长度为128位  </span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;cipher:\n&quot;</span>);</span><br><span class="line">    print_arr(sc_cipher, <span class="number">66</span>);</span><br><span class="line">    btea(sc_cipher, -n, k);  </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;decrypt:\n&quot;</span>);</span><br><span class="line">    print_arr(sc_cipher, <span class="number">66</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ror3:\n&quot;</span>);</span><br><span class="line">    ror(sc_cipher, <span class="number">66</span>*<span class="number">4</span>, <span class="number">3</span>);</span><br><span class="line">    print_arr(sc_cipher,<span class="number">66</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>转换一下大小端，b64一下得到shellcode。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">YPxoTHcmBzPSZItSMItSDItSFItyKA+3SiYz/zPArDxhfAIsIMHPDQP44vBSV4tSEItCPAPCi0B4hcAPhL4AAAADwlCLSBiLWCAD2oP5AA+EqQAAAEmLNIsD8jP/M8Cswc8NA/g6xHX0A3wkBDt8JAx12TP/M8mDwlAPtgQKwc8NA/hBg/kOdfHBzw1XM/8zyYtUJDxSD7YcDrhnZmZm9+vR+ovCwegfA8KNBIAr2FoPtgQKK8PBzw0D+EGD+Q511MHPDTs8JHQWaCVzAACLxGhubwAAVFCLXCRI/9PrFGglcwAAi8RoeWVzAFRQi1wkSP/TWFhYWFhYWFhYYcNYX1qLEukL////</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ss = <span class="string">&quot;LoadLibraryExA&quot;</span></span><br><span class="line">cmp = <span class="string">&quot;is program canno&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">14</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(<span class="built_in">ord</span>(cmp[i])+<span class="built_in">ord</span>(ss[i])%<span class="number">5</span>),end=<span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>得到flag</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jt&quot;psojvcq!gan</span><br></pre></td></tr></table></figure>





<h2 id="fpbe"><a href="#fpbe" class="headerlink" title="fpbe"></a>fpbe</h2><p>搜索一下题目和程序里面的函数符号可知考察的知识点是<code>ebpf</code>，里面也有一个ELF在<code>fpbe_bpf__create_skeleton</code>函数里面进行加载，主函数的check是一个SHA256，显然16字节爆破不了，于是转向这个ELF，提取出来，IDA可以解析但是难以反汇编。搜索一下发现可以通过以下方式获得机器码。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo sysctl net.core.bpf_jit_enable=2</span><br></pre></td></tr></table></figure>

<p>开启后运行程序就可以在<code>var/log/syslog</code>找到机器码了，逻辑也比较简单，一个线性方程组，z3解一下。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_7</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _QWORD *v0; <span class="comment">// rdi</span></span><br><span class="line">  __int64 v1; <span class="comment">// rsi</span></span><br><span class="line">  __int64 v2; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v3; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v4; <span class="comment">// rdi</span></span><br><span class="line">  __int64 v5; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">char</span> v7[<span class="number">40</span>]; <span class="comment">// [rsp+8h] [rbp-40h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v8[<span class="number">16</span>]; <span class="comment">// [rsp+30h] [rbp-18h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v9; <span class="comment">// [rsp+40h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v1 = v0[<span class="number">13</span>];</span><br><span class="line">  v2 = v0[<span class="number">14</span>];</span><br><span class="line">  v3 = v0[<span class="number">12</span>];</span><br><span class="line">  v4 = v0[<span class="number">11</span>];</span><br><span class="line">  v9 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(v8, <span class="number">0</span>, <span class="keyword">sizeof</span>(v8));</span><br><span class="line">  v5 = <span class="number">1</span>i64;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="number">52366</span>i64 * v4 + <span class="number">29179</span> * v3 + <span class="number">28096</span> * v2 + <span class="number">64392</span> * v1 == <span class="number">0xBE18A1735995</span>i64</span><br><span class="line">    &amp;&amp; <span class="number">37508</span>i64 * v4 + <span class="number">44499</span> * v3 + <span class="number">61887</span> * v2 + <span class="number">27365</span> * v1 == <span class="number">0xA556E5540340</span>i64</span><br><span class="line">    &amp;&amp; <span class="number">59154</span>i64 * v4 + <span class="number">25901</span> * v3 + <span class="number">56709</span> * v2 + <span class="number">32808</span> * v1 == <span class="number">0xA6F374484DA3</span>i64</span><br><span class="line">    &amp;&amp; <span class="number">62010</span>i64 * v4 + <span class="number">31886</span> * v3 + <span class="number">33324</span> * v2 + <span class="number">51779</span> * v1 == <span class="number">0xB99C485A7277</span>i64 )</span><br><span class="line">  &#123;</span><br><span class="line">    *&amp;v8[<span class="number">12</span>] = v4;</span><br><span class="line">    *&amp;v8[<span class="number">8</span>] = v3;</span><br><span class="line">    *&amp;v8[<span class="number">4</span>] = v1;</span><br><span class="line">    *v8 = v2;</span><br><span class="line">    <span class="built_in">strcpy</span>(v7, <span class="string">&quot;WELL DONE! YOUR FLAG: HFCTF&#123;%s&#125;\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line">s=Solver()</span><br><span class="line"></span><br><span class="line">v1 = Int(<span class="string">&#x27;flag1&#x27;</span>)</span><br><span class="line">v2 = Int(<span class="string">&#x27;flag2&#x27;</span>)</span><br><span class="line">v3 = Int(<span class="string">&#x27;flag3&#x27;</span>)</span><br><span class="line">v4 = Int(<span class="string">&#x27;flag4&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">s.add(<span class="number">52366</span> * v4 + <span class="number">29179</span> * v3 + <span class="number">28096</span> * v2 + <span class="number">64392</span> * v1 == <span class="number">0xBE18A1735995</span>)</span><br><span class="line">s.add(<span class="number">37508</span> * v4 + <span class="number">44499</span> * v3 + <span class="number">61887</span> * v2 + <span class="number">27365</span> * v1 == <span class="number">0xA556E5540340</span>)</span><br><span class="line">s.add(<span class="number">59154</span> * v4 + <span class="number">25901</span> * v3 + <span class="number">56709</span> * v2 + <span class="number">32808</span> * v1 == <span class="number">0xA6F374484DA3</span>)</span><br><span class="line">s.add(<span class="number">62010</span> * v4 + <span class="number">31886</span> * v3 + <span class="number">33324</span> * v2 + <span class="number">51779</span> * v1 == <span class="number">0xB99C485A7277</span> )</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> s.check() == sat:</span><br><span class="line">    <span class="built_in">print</span>(s.model())</span><br><span class="line"><span class="comment">#[flag2 = 861042224, flag1 = 1651261811,flag4 = 859138098, flag3 = 1148205171]</span></span><br></pre></td></tr></table></figure>

<p>试了半天不知道是顺序还是大小端问题，选择直接爆破。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">flag2 = [<span class="number">1651261811</span>, <span class="number">861042224</span>, <span class="number">1148205171</span>,<span class="number">859138098</span>]</span><br><span class="line"><span class="keyword">from</span> subprocess <span class="keyword">import</span> Popen, PIPE</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">payload</span>):</span><br><span class="line">    p = Popen([<span class="string">&quot;./fpbe&quot;</span>, payload.decode()[::-<span class="number">1</span>]],stdin=PIPE, stdout=PIPE, stderr=PIPE) </span><br><span class="line">    out, err = p.communicate() </span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> libnum <span class="keyword">import</span> n2s,s2n</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> permutations</span><br><span class="line">c = permutations(flag2,<span class="number">4</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> c:</span><br><span class="line">    s = <span class="string">b&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> i:</span><br><span class="line">        s += n2s(j)</span><br><span class="line">    <span class="built_in">print</span>(run(s))</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Successfully started! Please run `sudo cat /sys/kernel/debug/tracing/trace_pipe` to see output of the BPF programs.</span><br><span class="line">flag: HFCTF&#123;0vR3sAlbs8pD2h53&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Contra-2048"><a href="#Contra-2048" class="headerlink" title="Contra 2048"></a>Contra 2048</h2><p>给了个流量包和apk，是安卓+JS逆向，java层和native层都逆完了，但是JS不会去混淆，没出，待更新。</p>
<h3 id="native"><a href="#native" class="headerlink" title="native"></a>native</h3><p>字符串有混淆，在<code>datadiv_decode2801861751928700575</code>等函数中进行异或解密，模式简单，但是数量比较少，使用使用比赛时使用了人工反混淆技术。</p>
<p><code>Findcrypt</code>一下，发现了AES常量和MD5常量，跟进去交叉引用发现了根函数<code>sub_1474</code>,再次通过交叉引用发现该函数会通过Java层调用，方法名字是<code>docheck</code>。</p>
<img src="C:\Users\Devoke\AppData\Roaming\Typora\typora-user-images\image-20220320192923099.png" alt="image-20220320192923099" style="zoom:50%;" />

<p>其中<code>send_packet</code>函数与给的流量包有关，里面加了控制流平坦化，但是逻辑比较短，混淆不是很严重不影响分析，重点关注0002744开始的连续五个函数，以第二个函数<code>sub_28B0</code>为例，首先对参数buf进行包装，再用<code>KZoLJZlLkRlMOtuD</code>作为密钥对其进行AES-128加密，然后<code>malloc(0x34)</code>了一个堆用于储存要发送的数据。大致结构为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[H U F U] [02 00 00 00] [time(0)&lt;int&gt;] [MD5[0]] [11 00 00 00] [ff] [AES_encypt_payload] [padding]</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2022/03/20/rOvW8K53CSLPlxZ.png" alt="image-20220320194139707"></p>
<h3 id="流量包解密"><a href="#流量包解密" class="headerlink" title="流量包解密"></a>流量包解密</h3><p>其他流量包也采用了类似的方案，所以可以写脚本解密一下流量包。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">b2i</span>(<span class="params">b</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>.from_bytes(b, byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">aes_decrypt</span>(<span class="params">key, ciphertext</span>):</span><br><span class="line">    cipher = AES.new(key, AES.MODE_ECB)</span><br><span class="line">    <span class="keyword">return</span> cipher.decrypt(ciphertext)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">aes_encrypt</span>(<span class="params">key, plaintext</span>):</span><br><span class="line">    cipher = AES.new(key, AES.MODE_ECB)</span><br><span class="line">    <span class="keyword">return</span> cipher.encrypt(plaintext)</span><br><span class="line"></span><br><span class="line">key = <span class="string">b&quot;KZoLJZlLkRlMOtuD&quot;</span></span><br><span class="line">f= <span class="built_in">open</span>(<span class="string">&quot;data.txt&quot;</span>,<span class="string">&quot;r&quot;</span>)</span><br><span class="line">data = f.readlines()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> data[:-<span class="number">1</span>]:</span><br><span class="line">    packet = i.strip()</span><br><span class="line">    packet = <span class="built_in">bytes</span>.fromhex(packet)</span><br><span class="line">    packet_type = b2i(packet[<span class="number">4</span>:<span class="number">8</span>])</span><br><span class="line">    cipher = packet[<span class="number">21</span>:<span class="number">37</span>]</span><br><span class="line">    <span class="built_in">hash</span> = packet[<span class="number">12</span>:<span class="number">16</span>]</span><br><span class="line">    <span class="keyword">if</span>(packet_type == <span class="number">2</span>):</span><br><span class="line">        plaintext = aes_decrypt(key,cipher)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[*]c&quot;</span>,cipher.<span class="built_in">hex</span>(),<span class="string">&quot;m:&quot;</span>,plaintext.<span class="built_in">hex</span>())</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[*]c 111afaa675802d7a976c98c8c43e2da2 m: adde0000ae0000000000000000000000</span><br><span class="line">[*]c 521f3381f24ec5108baf200b6ec64db1 m: aede0000ab0000000000000000000000</span><br><span class="line">[*]c 6187ab272c1f0733ba6aaef76f188c59 m: afde0000cf0000000000000000000000</span><br><span class="line">[*]c 8fd161add05a735d3d383e948290fc31 m: b0de0000f60000000000000000000000</span><br><span class="line">[*]c be1eaf993a810db8ad5c7bb3504f7d90 m: b1de00004a0000000000000000000000</span><br><span class="line">[*]c c46b64bed6c6afec72bdc89b066ce7f3 m: b2de0000f90000000000000000000000</span><br><span class="line">[*]c b1049417ed4f022389adf0f4d5c4da9e m: b3de0000810000000000000000000000</span><br><span class="line">[*]c 1afd765f3cede067216b1ee0d2d42810 m: b4de0000030000000000000000000000</span><br><span class="line">[*]c e7be9ed7e94fa2023baa57f90b5851c8 m: b5de0000ae0000000000000000000000</span><br><span class="line">[*]c 34206c8223f731c478beb284a57f83c5 m: b6de0000840000000000000000000000</span><br><span class="line">[*]c d59dcad948aaf35a3f3ee82c1f967b38 m: b7de0000950000000000000000000000</span><br><span class="line">[*]c df7c66422e37ae41af3ca4311dcd4104 m: b8de0000300000000000000000000000</span><br><span class="line">[*]c f2319387bbcf9e7606f4256bf8790afd m: b9de0000390000000000000000000000</span><br><span class="line">[*]c d328266ebafe1ca097e12e4059b64c3e m: bade0000990000000000000000000000</span><br><span class="line">[*]c 5895762381fcebb40bc6ca46f129388d m: bbde0000da0000000000000000000000</span><br><span class="line">[*]c bf33b95ff573f418682ad60c447f44a9 m: bcde0000010000000000000000000000</span><br><span class="line">[*]c 208b18ec59fbf0617baf1c8c4d9b5903 m: bdde0000350000000000000000000000</span><br><span class="line">[*]c d4de18deb5c37cbc4eab9d022a8edeaa m: bede0000770000000000000000000000</span><br><span class="line">[*]c 554b25cc7d29625c902ce647871d6aae m: bfde0000360000000000000000000000</span><br><span class="line">[*]c af9074a520dc0be68c012756b80d2de9 m: c0de0000e70000000000000000000000</span><br><span class="line">[*]c d8b27655d8cde7f2cdc7a74754953337 m: c1de00007c0000000000000000000000</span><br><span class="line">[*]c ca8ee61dc6728813a8e41e9be80a6764 m: c2de0000410000000000000000000000</span><br><span class="line">[*]c fc95be5241f8a59eb580eba5fb91fddf m: c3de00004d0000000000000000000000</span><br><span class="line">[*]c 2ba133fa3879e6347b3ae8e55fbc944a m: c4de0000430000000000000000000000</span><br><span class="line">[*]c c60df505a2932ca68e3530af6bc41bbb m: c5de0000ef0000000000000000000000</span><br><span class="line">[*]c c64a847747cc70e603bab516386ca721 m: c6de0000b00000000000000000000000</span><br><span class="line">[*]c 1737b1a23ec2bd493ab1a6275b6e2eb2 m: c7de0000aa0000000000000000000000</span><br><span class="line">[*]c 2cf65d658c1fc558d9f43321000e9e68 m: c8de00009b0000000000000000000000</span><br><span class="line">[*]c 6beee41275f03f30485af8bee805805c m: c9de0000010000000000000000000000</span><br><span class="line">[*]c 8b821cac8196275904bbb53a11b831d5 m: cade0000270000000000000000000000</span><br><span class="line">[*]c d230fab6b044854fd518219a12942c65 m: cbde0000210000000000000000000000</span><br><span class="line">[*]c a0435d523e66126d7e6fe850492319a2 m: ccde00009c0000000000000000000000</span><br><span class="line">[*]c 0fe33dede172c8d2bca1f1cda054f641 m: cdde0000020000000000000000000000</span><br><span class="line">[*]c ca4633933b0464fc3158e4ccb987fc8f m: cede0000e10000000000000000000000</span><br><span class="line">[*]c 6e3f1bc661417ef0f5d2aa23630fa113 m: cfde00000e0000000000000000000000</span><br><span class="line">[*]c 95729dfa6ee0629f5f7fb8b443bddf7d m: d0de0000670000000000000000000000</span><br><span class="line">[*]c aee28a1366cc508ff196e160dd9e5ac4 m: d1de0000c20000000000000000000000</span><br><span class="line">[*]c 9aa2b87453e0f0dabcf02667ba668c15 m: d2de0000bd0000000000000000000000</span><br><span class="line">[*]c d1a2347614fa59ecfb2ac964c1198fa0 m: d3de0000fe0000000000000000000000</span><br><span class="line">[*]c c1aff18b31c51a7ce47d3a2277515b55 m: d4de0000c20000000000000000000000</span><br><span class="line">[*]c ac25f6f85a0668f26b53bda11d5f10b0 m: d5de0000a30000000000000000000000</span><br><span class="line">[*]c af38d6d29ebfbbc44a85538b69adf05a m: d6de0000970000000000000000000000</span><br><span class="line">[*]c f17f0bec7ade982167e8903b0bd55368 m: d7de0000ea0000000000000000000000</span><br><span class="line">[*]c af6009e720b4d142d249c55afcc0892f m: d8de0000ef0000000000000000000000</span><br><span class="line">[*]c f42702d51a7c62683ab60b3ecbd5180d m: d9de0000650000000000000000000000</span><br><span class="line">[*]c 8969dcc7f808b88aff97be2d0942431c m: dade0000ed0000000000000000000000</span><br><span class="line">[*]c acadd756fd5a86401c88b0d0469c7152 m: dbde00008b0000000000000000000000</span><br><span class="line">[*]c 7b9772ccb2282ff68ed5d77132785c04 m: dcde0000410000000000000000000000</span><br></pre></td></tr></table></figure>

<p>解密出来的结果有明显的规律，在<code>send_packet</code>函数里查看参数，发现前4字节是<code>0xdead+idx</code>，后一个字节就是<code>buf[idx]</code>。</p>
<p><img src="https://s2.loli.net/2022/03/20/mnJAvQfgwUSWG7h.png" alt="image-20220320194807605"></p>
<h3 id="溯源"><a href="#溯源" class="headerlink" title="溯源"></a>溯源</h3><p>跟踪一下上述的<code>buf</code>，发现他是由<code>sub_13E4</code>生成的，48个字节对应48个流量包里第五个字节，所以明显流量包里的就是密文了。函数逻辑也比较短，一个换表<code>b64decode</code>，一个<code>AES-128-ECB</code>,S盒也经过改变，所以拿到key就可以进行解密了。</p>
<p><img src="https://s2.loli.net/2022/03/20/AuM1vG7FUBRWOoS.png" alt="image-20220320195542550"></p>
<p>交叉引用一下，发现该全局变量在函数<code>Java_com_test_hufu22_TestActivity_prenative</code>中进行了赋值，显然这又是一个来自Java层的调用,JEB逆向一下，可知这些方法都经过 <code>@JavascriptInterface</code>修饰，说明他们都可能使用Javscript来调用，解包apk在<code>assets/web/js</code>发现了经过混淆的<code>game_manager.js</code>，通过<a target="_blank" rel="noopener" href="http://www.dejs.vip/encry_decry/obfuscator.html">DeJS - js解密,js反混淆,js美化工具</a>可以恢复一部分内容，获得key <code>Hello from 2048!</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">GameManager</span>.<span class="property"><span class="keyword">prototype</span></span>[<span class="string">&quot;checkseq&quot;</span>] = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (seq.<span class="property">length</span> &lt; <span class="number">100</span>) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="title class_">Value</span>_s0 = <span class="number">0</span>; <span class="title class_">Value</span>_s0 &lt; <span class="title class_">Math</span>.<span class="title function_">floor</span>(seq.<span class="property">length</span> / <span class="number">4</span>); <span class="title class_">Value</span>_s0++) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Cheat code: &quot;</span> + _0x2603b4);</span><br><span class="line">    <span class="keyword">var</span> _0x382931 = <span class="title function_">kzlso</span>(<span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">gameManager</span>.<span class="title function_">pre</span>(<span class="string">&quot;Hello from 2048!&quot;</span>); <span class="comment">//调用Java_com_test_hufu22_TestActivity_prenative</span></span><br><span class="line">    bbb = <span class="title function_">fromByteArray</span>(<span class="title function_">string2Bin</span>(_0x382931));</span><br><span class="line">    res = <span class="variable language_">window</span>.<span class="property">gameManager</span>.<span class="title function_">docheck</span>(bbb);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line">    seq = <span class="keyword">new</span> <span class="title class_">Array</span>();</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">String</span>(res) == <span class="string">&quot;Bingo!&quot;</span>) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="解密"><a href="#解密" class="headerlink" title="解密"></a>解密</h3><p>首先要计算<code>Inv_sbox</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> sbox[<span class="number">256</span>] = </span><br><span class="line">    &#123; </span><br><span class="line">       <span class="number">0xFC</span>, <span class="number">0xA1</span>, <span class="number">0xC1</span>, <span class="number">0x37</span>, <span class="number">0x3B</span>, <span class="number">0x43</span>, <span class="number">0x15</span>, <span class="number">0xDE</span>, <span class="number">0x7E</span>, <span class="number">0x24</span>, </span><br><span class="line">  <span class="number">0x22</span>, <span class="number">0xEA</span>, <span class="number">0x62</span>, <span class="number">0xC2</span>, <span class="number">0x9F</span>, <span class="number">0x8F</span>, <span class="number">0xA0</span>, <span class="number">0x3D</span>, <span class="number">0xF0</span>, <span class="number">0x05</span>, </span><br><span class="line">  <span class="number">0xA9</span>, <span class="number">0x7B</span>, <span class="number">0x74</span>, <span class="number">0x50</span>, <span class="number">0xB9</span>, <span class="number">0x71</span>, <span class="number">0x58</span>, <span class="number">0x0F</span>, <span class="number">0xE1</span>, <span class="number">0x21</span>, </span><br><span class="line">  <span class="number">0xB0</span>, <span class="number">0x85</span>, <span class="number">0x25</span>, <span class="number">0x8D</span>, <span class="number">0x6A</span>, <span class="number">0x97</span>, <span class="number">0x91</span>, <span class="number">0x3F</span>, <span class="number">0xAD</span>, <span class="number">0x6D</span>, </span><br><span class="line">  <span class="number">0xB7</span>, <span class="number">0xB4</span>, <span class="number">0xD0</span>, <span class="number">0x2C</span>, <span class="number">0x0C</span>, <span class="number">0x56</span>, <span class="number">0x7A</span>, <span class="number">0xAB</span>, <span class="number">0x0A</span>, <span class="number">0x5B</span>, </span><br><span class="line">  <span class="number">0x83</span>, <span class="number">0xC5</span>, <span class="number">0xD6</span>, <span class="number">0x52</span>, <span class="number">0xB6</span>, <span class="number">0x88</span>, <span class="number">0xC0</span>, <span class="number">0xC4</span>, <span class="number">0x5F</span>, <span class="number">0x92</span>, </span><br><span class="line">  <span class="number">0xBC</span>, <span class="number">0xE2</span>, <span class="number">0x1A</span>, <span class="number">0x4D</span>, <span class="number">0x76</span>, <span class="number">0x1F</span>, <span class="number">0x89</span>, <span class="number">0x1C</span>, <span class="number">0x23</span>, <span class="number">0xDF</span>, </span><br><span class="line">  <span class="number">0xCA</span>, <span class="number">0x60</span>, <span class="number">0xE0</span>, <span class="number">0x17</span>, <span class="number">0x36</span>, <span class="number">0x75</span>, <span class="number">0xA7</span>, <span class="number">0x9E</span>, <span class="number">0x14</span>, <span class="number">0x5A</span>, </span><br><span class="line">  <span class="number">0x02</span>, <span class="number">0x46</span>, <span class="number">0x4A</span>, <span class="number">0x11</span>, <span class="number">0x2F</span>, <span class="number">0x8B</span>, <span class="number">0xF4</span>, <span class="number">0x33</span>, <span class="number">0xF2</span>, <span class="number">0x6E</span>, </span><br><span class="line">  <span class="number">0x72</span>, <span class="number">0xA5</span>, <span class="number">0xC7</span>, <span class="number">0xE3</span>, <span class="number">0xDA</span>, <span class="number">0x38</span>, <span class="number">0x53</span>, <span class="number">0x9B</span>, <span class="number">0x87</span>, <span class="number">0x09</span>, </span><br><span class="line">  <span class="number">0x01</span>, <span class="number">0x4B</span>, <span class="number">0xA4</span>, <span class="number">0x42</span>, <span class="number">0x2E</span>, <span class="number">0xE7</span>, <span class="number">0x3A</span>, <span class="number">0x84</span>, <span class="number">0x12</span>, <span class="number">0x7F</span>, </span><br><span class="line">  <span class="number">0x07</span>, <span class="number">0xBE</span>, <span class="number">0xC8</span>, <span class="number">0xC9</span>, <span class="number">0x13</span>, <span class="number">0x47</span>, <span class="number">0xFE</span>, <span class="number">0xD1</span>, <span class="number">0xAC</span>, <span class="number">0xF6</span>, </span><br><span class="line">  <span class="number">0xF1</span>, <span class="number">0xA8</span>, <span class="number">0x96</span>, <span class="number">0xB2</span>, <span class="number">0xC6</span>, <span class="number">0x18</span>, <span class="number">0xFB</span>, <span class="number">0xD4</span>, <span class="number">0x82</span>, <span class="number">0x16</span>, </span><br><span class="line">  <span class="number">0x73</span>, <span class="number">0x64</span>, <span class="number">0x5E</span>, <span class="number">0x7D</span>, <span class="number">0xEF</span>, <span class="number">0x0E</span>, <span class="number">0xAE</span>, <span class="number">0xA2</span>, <span class="number">0x0B</span>, <span class="number">0x30</span>, </span><br><span class="line">  <span class="number">0xF7</span>, <span class="number">0xDD</span>, <span class="number">0xA6</span>, <span class="number">0x29</span>, <span class="number">0x6C</span>, <span class="number">0xDC</span>, <span class="number">0x98</span>, <span class="number">0xFA</span>, <span class="number">0xBD</span>, <span class="number">0x67</span>, </span><br><span class="line">  <span class="number">0xD5</span>, <span class="number">0xD8</span>, <span class="number">0xAF</span>, <span class="number">0x51</span>, <span class="number">0xE4</span>, <span class="number">0xBF</span>, <span class="number">0x65</span>, <span class="number">0x1D</span>, <span class="number">0xF8</span>, <span class="number">0xCE</span>, </span><br><span class="line">  <span class="number">0x9C</span>, <span class="number">0x26</span>, <span class="number">0xF3</span>, <span class="number">0x2A</span>, <span class="number">0x9A</span>, <span class="number">0x45</span>, <span class="number">0x08</span>, <span class="number">0x5C</span>, <span class="number">0x57</span>, <span class="number">0x06</span>, </span><br><span class="line">  <span class="number">0x54</span>, <span class="number">0x2B</span>, <span class="number">0x41</span>, <span class="number">0x70</span>, <span class="number">0xB1</span>, <span class="number">0x63</span>, <span class="number">0x66</span>, <span class="number">0x3C</span>, <span class="number">0x44</span>, <span class="number">0x10</span>, </span><br><span class="line">  <span class="number">0x31</span>, <span class="number">0x19</span>, <span class="number">0x86</span>, <span class="number">0x61</span>, <span class="number">0x6B</span>, <span class="number">0xD7</span>, <span class="number">0x79</span>, <span class="number">0xCB</span>, <span class="number">0x81</span>, <span class="number">0x69</span>, </span><br><span class="line">  <span class="number">0x0D</span>, <span class="number">0xD2</span>, <span class="number">0xFF</span>, <span class="number">0x2D</span>, <span class="number">0x40</span>, <span class="number">0x03</span>, <span class="number">0x90</span>, <span class="number">0x9D</span>, <span class="number">0xE9</span>, <span class="number">0x4C</span>, </span><br><span class="line">  <span class="number">0xCD</span>, <span class="number">0x00</span>, <span class="number">0xE5</span>, <span class="number">0x80</span>, <span class="number">0xDB</span>, <span class="number">0xBA</span>, <span class="number">0xCF</span>, <span class="number">0x48</span>, <span class="number">0xD9</span>, <span class="number">0x3E</span>, </span><br><span class="line">  <span class="number">0xFD</span>, <span class="number">0x4F</span>, <span class="number">0xEE</span>, <span class="number">0x8E</span>, <span class="number">0x4E</span>, <span class="number">0x77</span>, <span class="number">0xA3</span>, <span class="number">0xB5</span>, <span class="number">0x5D</span>, <span class="number">0x32</span>, </span><br><span class="line">  <span class="number">0xE6</span>, <span class="number">0x68</span>, <span class="number">0x27</span>, <span class="number">0xAA</span>, <span class="number">0xE8</span>, <span class="number">0x55</span>, <span class="number">0xF5</span>, <span class="number">0xCC</span>, <span class="number">0x78</span>, <span class="number">0x6F</span>, </span><br><span class="line">  <span class="number">0xD3</span>, <span class="number">0x93</span>, <span class="number">0x7C</span>, <span class="number">0x28</span>, <span class="number">0x99</span>, <span class="number">0x34</span>, <span class="number">0xB3</span>, <span class="number">0x04</span>, <span class="number">0x95</span>, <span class="number">0x49</span>, </span><br><span class="line">  <span class="number">0xED</span>, <span class="number">0x8A</span>, <span class="number">0xF9</span>, <span class="number">0x1E</span>, <span class="number">0xB8</span>, <span class="number">0xC3</span>, <span class="number">0x8C</span>, <span class="number">0x59</span>, <span class="number">0xEB</span>, <span class="number">0xEC</span>, </span><br><span class="line">  <span class="number">0x35</span>, <span class="number">0x39</span>, <span class="number">0xBB</span>, <span class="number">0x1B</span>, <span class="number">0x94</span>, <span class="number">0x20</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> sbox_inv[<span class="number">256</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> temp1 = sbox[i];</span><br><span class="line"></span><br><span class="line">        sbox_inv[temp1] = i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> line = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++)</span><br><span class="line">    &#123;   line++;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;0x%X%X, &quot;</span>, sbox_inv[i] / <span class="number">16</span>, sbox_inv[i] % <span class="number">16</span>);</span><br><span class="line">        <span class="keyword">if</span>(line == <span class="number">16</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            line = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line">N_ROUNDS = <span class="number">10</span></span><br><span class="line">s_box = (<span class="number">0xFC</span>, <span class="number">0xA1</span>, <span class="number">0xC1</span>, <span class="number">0x37</span>, <span class="number">0x3B</span>, <span class="number">0x43</span>, <span class="number">0x15</span>, <span class="number">0xDE</span>, <span class="number">0x7E</span>, <span class="number">0x24</span>, </span><br><span class="line">  <span class="number">0x22</span>, <span class="number">0xEA</span>, <span class="number">0x62</span>, <span class="number">0xC2</span>, <span class="number">0x9F</span>, <span class="number">0x8F</span>, <span class="number">0xA0</span>, <span class="number">0x3D</span>, <span class="number">0xF0</span>, <span class="number">0x05</span>, </span><br><span class="line">  <span class="number">0xA9</span>, <span class="number">0x7B</span>, <span class="number">0x74</span>, <span class="number">0x50</span>, <span class="number">0xB9</span>, <span class="number">0x71</span>, <span class="number">0x58</span>, <span class="number">0x0F</span>, <span class="number">0xE1</span>, <span class="number">0x21</span>, </span><br><span class="line">  <span class="number">0xB0</span>, <span class="number">0x85</span>, <span class="number">0x25</span>, <span class="number">0x8D</span>, <span class="number">0x6A</span>, <span class="number">0x97</span>, <span class="number">0x91</span>, <span class="number">0x3F</span>, <span class="number">0xAD</span>, <span class="number">0x6D</span>, </span><br><span class="line">  <span class="number">0xB7</span>, <span class="number">0xB4</span>, <span class="number">0xD0</span>, <span class="number">0x2C</span>, <span class="number">0x0C</span>, <span class="number">0x56</span>, <span class="number">0x7A</span>, <span class="number">0xAB</span>, <span class="number">0x0A</span>, <span class="number">0x5B</span>, </span><br><span class="line">  <span class="number">0x83</span>, <span class="number">0xC5</span>, <span class="number">0xD6</span>, <span class="number">0x52</span>, <span class="number">0xB6</span>, <span class="number">0x88</span>, <span class="number">0xC0</span>, <span class="number">0xC4</span>, <span class="number">0x5F</span>, <span class="number">0x92</span>, </span><br><span class="line">  <span class="number">0xBC</span>, <span class="number">0xE2</span>, <span class="number">0x1A</span>, <span class="number">0x4D</span>, <span class="number">0x76</span>, <span class="number">0x1F</span>, <span class="number">0x89</span>, <span class="number">0x1C</span>, <span class="number">0x23</span>, <span class="number">0xDF</span>, </span><br><span class="line">  <span class="number">0xCA</span>, <span class="number">0x60</span>, <span class="number">0xE0</span>, <span class="number">0x17</span>, <span class="number">0x36</span>, <span class="number">0x75</span>, <span class="number">0xA7</span>, <span class="number">0x9E</span>, <span class="number">0x14</span>, <span class="number">0x5A</span>, </span><br><span class="line">  <span class="number">0x02</span>, <span class="number">0x46</span>, <span class="number">0x4A</span>, <span class="number">0x11</span>, <span class="number">0x2F</span>, <span class="number">0x8B</span>, <span class="number">0xF4</span>, <span class="number">0x33</span>, <span class="number">0xF2</span>, <span class="number">0x6E</span>, </span><br><span class="line">  <span class="number">0x72</span>, <span class="number">0xA5</span>, <span class="number">0xC7</span>, <span class="number">0xE3</span>, <span class="number">0xDA</span>, <span class="number">0x38</span>, <span class="number">0x53</span>, <span class="number">0x9B</span>, <span class="number">0x87</span>, <span class="number">0x09</span>, </span><br><span class="line">  <span class="number">0x01</span>, <span class="number">0x4B</span>, <span class="number">0xA4</span>, <span class="number">0x42</span>, <span class="number">0x2E</span>, <span class="number">0xE7</span>, <span class="number">0x3A</span>, <span class="number">0x84</span>, <span class="number">0x12</span>, <span class="number">0x7F</span>, </span><br><span class="line">  <span class="number">0x07</span>, <span class="number">0xBE</span>, <span class="number">0xC8</span>, <span class="number">0xC9</span>, <span class="number">0x13</span>, <span class="number">0x47</span>, <span class="number">0xFE</span>, <span class="number">0xD1</span>, <span class="number">0xAC</span>, <span class="number">0xF6</span>, </span><br><span class="line">  <span class="number">0xF1</span>, <span class="number">0xA8</span>, <span class="number">0x96</span>, <span class="number">0xB2</span>, <span class="number">0xC6</span>, <span class="number">0x18</span>, <span class="number">0xFB</span>, <span class="number">0xD4</span>, <span class="number">0x82</span>, <span class="number">0x16</span>, </span><br><span class="line">  <span class="number">0x73</span>, <span class="number">0x64</span>, <span class="number">0x5E</span>, <span class="number">0x7D</span>, <span class="number">0xEF</span>, <span class="number">0x0E</span>, <span class="number">0xAE</span>, <span class="number">0xA2</span>, <span class="number">0x0B</span>, <span class="number">0x30</span>, </span><br><span class="line">  <span class="number">0xF7</span>, <span class="number">0xDD</span>, <span class="number">0xA6</span>, <span class="number">0x29</span>, <span class="number">0x6C</span>, <span class="number">0xDC</span>, <span class="number">0x98</span>, <span class="number">0xFA</span>, <span class="number">0xBD</span>, <span class="number">0x67</span>, </span><br><span class="line">  <span class="number">0xD5</span>, <span class="number">0xD8</span>, <span class="number">0xAF</span>, <span class="number">0x51</span>, <span class="number">0xE4</span>, <span class="number">0xBF</span>, <span class="number">0x65</span>, <span class="number">0x1D</span>, <span class="number">0xF8</span>, <span class="number">0xCE</span>, </span><br><span class="line">  <span class="number">0x9C</span>, <span class="number">0x26</span>, <span class="number">0xF3</span>, <span class="number">0x2A</span>, <span class="number">0x9A</span>, <span class="number">0x45</span>, <span class="number">0x08</span>, <span class="number">0x5C</span>, <span class="number">0x57</span>, <span class="number">0x06</span>, </span><br><span class="line">  <span class="number">0x54</span>, <span class="number">0x2B</span>, <span class="number">0x41</span>, <span class="number">0x70</span>, <span class="number">0xB1</span>, <span class="number">0x63</span>, <span class="number">0x66</span>, <span class="number">0x3C</span>, <span class="number">0x44</span>, <span class="number">0x10</span>, </span><br><span class="line">  <span class="number">0x31</span>, <span class="number">0x19</span>, <span class="number">0x86</span>, <span class="number">0x61</span>, <span class="number">0x6B</span>, <span class="number">0xD7</span>, <span class="number">0x79</span>, <span class="number">0xCB</span>, <span class="number">0x81</span>, <span class="number">0x69</span>, </span><br><span class="line">  <span class="number">0x0D</span>, <span class="number">0xD2</span>, <span class="number">0xFF</span>, <span class="number">0x2D</span>, <span class="number">0x40</span>, <span class="number">0x03</span>, <span class="number">0x90</span>, <span class="number">0x9D</span>, <span class="number">0xE9</span>, <span class="number">0x4C</span>, </span><br><span class="line">  <span class="number">0xCD</span>, <span class="number">0x00</span>, <span class="number">0xE5</span>, <span class="number">0x80</span>, <span class="number">0xDB</span>, <span class="number">0xBA</span>, <span class="number">0xCF</span>, <span class="number">0x48</span>, <span class="number">0xD9</span>, <span class="number">0x3E</span>, </span><br><span class="line">  <span class="number">0xFD</span>, <span class="number">0x4F</span>, <span class="number">0xEE</span>, <span class="number">0x8E</span>, <span class="number">0x4E</span>, <span class="number">0x77</span>, <span class="number">0xA3</span>, <span class="number">0xB5</span>, <span class="number">0x5D</span>, <span class="number">0x32</span>, </span><br><span class="line">  <span class="number">0xE6</span>, <span class="number">0x68</span>, <span class="number">0x27</span>, <span class="number">0xAA</span>, <span class="number">0xE8</span>, <span class="number">0x55</span>, <span class="number">0xF5</span>, <span class="number">0xCC</span>, <span class="number">0x78</span>, <span class="number">0x6F</span>, </span><br><span class="line">  <span class="number">0xD3</span>, <span class="number">0x93</span>, <span class="number">0x7C</span>, <span class="number">0x28</span>, <span class="number">0x99</span>, <span class="number">0x34</span>, <span class="number">0xB3</span>, <span class="number">0x04</span>, <span class="number">0x95</span>, <span class="number">0x49</span>, </span><br><span class="line">  <span class="number">0xED</span>, <span class="number">0x8A</span>, <span class="number">0xF9</span>, <span class="number">0x1E</span>, <span class="number">0xB8</span>, <span class="number">0xC3</span>, <span class="number">0x8C</span>, <span class="number">0x59</span>, <span class="number">0xEB</span>, <span class="number">0xEC</span>, </span><br><span class="line">  <span class="number">0x35</span>, <span class="number">0x39</span>, <span class="number">0xBB</span>, <span class="number">0x1B</span>, <span class="number">0x94</span>, <span class="number">0x20</span>)</span><br><span class="line"></span><br><span class="line">inv_s_box=(<span class="number">0xC9</span>, <span class="number">0x64</span>, <span class="number">0x50</span>, <span class="number">0xC3</span>, <span class="number">0xED</span>, <span class="number">0x13</span>, <span class="number">0xA9</span>, <span class="number">0x6E</span>, <span class="number">0xA6</span>, <span class="number">0x63</span>, <span class="number">0x30</span>, <span class="number">0x8A</span>, <span class="number">0x2C</span>, <span class="number">0xBE</span>, <span class="number">0x87</span>, <span class="number">0x1B</span>,</span><br><span class="line"><span class="number">0xB3</span>, <span class="number">0x53</span>, <span class="number">0x6C</span>, <span class="number">0x72</span>, <span class="number">0x4E</span>, <span class="number">0x06</span>, <span class="number">0x81</span>, <span class="number">0x49</span>, <span class="number">0x7D</span>, <span class="number">0xB5</span>, <span class="number">0x3E</span>, <span class="number">0xFD</span>, <span class="number">0x43</span>, <span class="number">0x9D</span>, <span class="number">0xF3</span>, <span class="number">0x41</span>,</span><br><span class="line"><span class="number">0xFF</span>, <span class="number">0x1D</span>, <span class="number">0x0A</span>, <span class="number">0x44</span>, <span class="number">0x09</span>, <span class="number">0x20</span>, <span class="number">0xA1</span>, <span class="number">0xDE</span>, <span class="number">0xE9</span>, <span class="number">0x8F</span>, <span class="number">0xA3</span>, <span class="number">0xAB</span>, <span class="number">0x2B</span>, <span class="number">0xC1</span>, <span class="number">0x68</span>, <span class="number">0x54</span>,</span><br><span class="line"><span class="number">0x8B</span>, <span class="number">0xB4</span>, <span class="number">0xDB</span>, <span class="number">0x57</span>, <span class="number">0xEB</span>, <span class="number">0xFA</span>, <span class="number">0x4A</span>, <span class="number">0x03</span>, <span class="number">0x5F</span>, <span class="number">0xFB</span>, <span class="number">0x6A</span>, <span class="number">0x04</span>, <span class="number">0xB1</span>, <span class="number">0x11</span>, <span class="number">0xD1</span>, <span class="number">0x25</span>,</span><br><span class="line"><span class="number">0xC2</span>, <span class="number">0xAC</span>, <span class="number">0x67</span>, <span class="number">0x05</span>, <span class="number">0xB2</span>, <span class="number">0xA5</span>, <span class="number">0x51</span>, <span class="number">0x73</span>, <span class="number">0xCF</span>, <span class="number">0xEF</span>, <span class="number">0x52</span>, <span class="number">0x65</span>, <span class="number">0xC7</span>, <span class="number">0x3F</span>, <span class="number">0xD6</span>, <span class="number">0xD3</span>,</span><br><span class="line"><span class="number">0x17</span>, <span class="number">0x99</span>, <span class="number">0x35</span>, <span class="number">0x60</span>, <span class="number">0xAA</span>, <span class="number">0xE1</span>, <span class="number">0x2D</span>, <span class="number">0xA8</span>, <span class="number">0x1A</span>, <span class="number">0xF7</span>, <span class="number">0x4F</span>, <span class="number">0x31</span>, <span class="number">0xA7</span>, <span class="number">0xDA</span>, <span class="number">0x84</span>, <span class="number">0x3A</span>,</span><br><span class="line"><span class="number">0x47</span>, <span class="number">0xB7</span>, <span class="number">0x0C</span>, <span class="number">0xAF</span>, <span class="number">0x83</span>, <span class="number">0x9C</span>, <span class="number">0xB0</span>, <span class="number">0x95</span>, <span class="number">0xDD</span>, <span class="number">0xBD</span>, <span class="number">0x22</span>, <span class="number">0xB8</span>, <span class="number">0x90</span>, <span class="number">0x27</span>, <span class="number">0x59</span>, <span class="number">0xE5</span>,</span><br><span class="line"><span class="number">0xAD</span>, <span class="number">0x19</span>, <span class="number">0x5A</span>, <span class="number">0x82</span>, <span class="number">0x16</span>, <span class="number">0x4B</span>, <span class="number">0x40</span>, <span class="number">0xD7</span>, <span class="number">0xE4</span>, <span class="number">0xBA</span>, <span class="number">0x2E</span>, <span class="number">0x15</span>, <span class="number">0xE8</span>, <span class="number">0x85</span>, <span class="number">0x08</span>, <span class="number">0x6D</span>,</span><br><span class="line"><span class="number">0xCB</span>, <span class="number">0xBC</span>, <span class="number">0x80</span>, <span class="number">0x32</span>, <span class="number">0x6B</span>, <span class="number">0x1F</span>, <span class="number">0xB6</span>, <span class="number">0x62</span>, <span class="number">0x37</span>, <span class="number">0x42</span>, <span class="number">0xF1</span>, <span class="number">0x55</span>, <span class="number">0xF6</span>, <span class="number">0x21</span>, <span class="number">0xD5</span>, <span class="number">0x0F</span>,</span><br><span class="line"><span class="number">0xC4</span>, <span class="number">0x24</span>, <span class="number">0x3B</span>, <span class="number">0xE7</span>, <span class="number">0xFE</span>, <span class="number">0xEE</span>, <span class="number">0x7A</span>, <span class="number">0x23</span>, <span class="number">0x92</span>, <span class="number">0xEA</span>, <span class="number">0xA4</span>, <span class="number">0x61</span>, <span class="number">0xA0</span>, <span class="number">0xC5</span>, <span class="number">0x4D</span>, <span class="number">0x0E</span>,</span><br><span class="line"><span class="number">0x10</span>, <span class="number">0x01</span>, <span class="number">0x89</span>, <span class="number">0xD8</span>, <span class="number">0x66</span>, <span class="number">0x5B</span>, <span class="number">0x8E</span>, <span class="number">0x4C</span>, <span class="number">0x79</span>, <span class="number">0x14</span>, <span class="number">0xDF</span>, <span class="number">0x2F</span>, <span class="number">0x76</span>, <span class="number">0x26</span>, <span class="number">0x88</span>, <span class="number">0x98</span>,</span><br><span class="line"><span class="number">0x1E</span>, <span class="number">0xAE</span>, <span class="number">0x7B</span>, <span class="number">0xEC</span>, <span class="number">0x29</span>, <span class="number">0xD9</span>, <span class="number">0x36</span>, <span class="number">0x28</span>, <span class="number">0xF4</span>, <span class="number">0x18</span>, <span class="number">0xCD</span>, <span class="number">0xFC</span>, <span class="number">0x3C</span>, <span class="number">0x94</span>, <span class="number">0x6F</span>, <span class="number">0x9B</span>,</span><br><span class="line"><span class="number">0x38</span>, <span class="number">0x02</span>, <span class="number">0x0D</span>, <span class="number">0xF5</span>, <span class="number">0x39</span>, <span class="number">0x33</span>, <span class="number">0x7C</span>, <span class="number">0x5C</span>, <span class="number">0x70</span>, <span class="number">0x71</span>, <span class="number">0x46</span>, <span class="number">0xBB</span>, <span class="number">0xE3</span>, <span class="number">0xC8</span>, <span class="number">0x9F</span>, <span class="number">0xCE</span>,</span><br><span class="line"><span class="number">0x2A</span>, <span class="number">0x75</span>, <span class="number">0xBF</span>, <span class="number">0xE6</span>, <span class="number">0x7F</span>, <span class="number">0x96</span>, <span class="number">0x34</span>, <span class="number">0xB9</span>, <span class="number">0x97</span>, <span class="number">0xD0</span>, <span class="number">0x5E</span>, <span class="number">0xCC</span>, <span class="number">0x91</span>, <span class="number">0x8D</span>, <span class="number">0x07</span>, <span class="number">0x45</span>,</span><br><span class="line"><span class="number">0x48</span>, <span class="number">0x1C</span>, <span class="number">0x3D</span>, <span class="number">0x5D</span>, <span class="number">0x9A</span>, <span class="number">0xCA</span>, <span class="number">0xDC</span>, <span class="number">0x69</span>, <span class="number">0xE0</span>, <span class="number">0xC6</span>, <span class="number">0x0B</span>, <span class="number">0xF8</span>, <span class="number">0xF9</span>, <span class="number">0xF0</span>, <span class="number">0xD4</span>, <span class="number">0x86</span>,</span><br><span class="line"><span class="number">0x12</span>, <span class="number">0x78</span>, <span class="number">0x58</span>, <span class="number">0xA2</span>, <span class="number">0x56</span>, <span class="number">0xE2</span>, <span class="number">0x77</span>, <span class="number">0x8C</span>, <span class="number">0x9E</span>, <span class="number">0xF2</span>, <span class="number">0x93</span>, <span class="number">0x7E</span>, <span class="number">0x00</span>, <span class="number">0xD2</span>, <span class="number">0x74</span>, <span class="number">0xC0</span>,</span><br><span class="line">)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">shift_rows</span>(<span class="params">s</span>):</span><br><span class="line">    s[<span class="number">0</span>][<span class="number">1</span>], s[<span class="number">1</span>][<span class="number">1</span>], s[<span class="number">2</span>][<span class="number">1</span>], s[<span class="number">3</span>][<span class="number">1</span>] = s[<span class="number">1</span>][<span class="number">1</span>], s[<span class="number">2</span>][<span class="number">1</span>], s[<span class="number">3</span>][<span class="number">1</span>], s[<span class="number">0</span>][<span class="number">1</span>]</span><br><span class="line">    s[<span class="number">0</span>][<span class="number">2</span>], s[<span class="number">1</span>][<span class="number">2</span>], s[<span class="number">2</span>][<span class="number">2</span>], s[<span class="number">3</span>][<span class="number">2</span>] = s[<span class="number">2</span>][<span class="number">2</span>], s[<span class="number">3</span>][<span class="number">2</span>], s[<span class="number">0</span>][<span class="number">2</span>], s[<span class="number">1</span>][<span class="number">2</span>]</span><br><span class="line">    s[<span class="number">0</span>][<span class="number">3</span>], s[<span class="number">1</span>][<span class="number">3</span>], s[<span class="number">2</span>][<span class="number">3</span>], s[<span class="number">3</span>][<span class="number">3</span>] = s[<span class="number">3</span>][<span class="number">3</span>], s[<span class="number">0</span>][<span class="number">3</span>], s[<span class="number">1</span>][<span class="number">3</span>], s[<span class="number">2</span>][<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inv_shift_rows</span>(<span class="params">s</span>):</span><br><span class="line">    s[<span class="number">1</span>][<span class="number">1</span>], s[<span class="number">2</span>][<span class="number">1</span>], s[<span class="number">3</span>][<span class="number">1</span>], s[<span class="number">0</span>][<span class="number">1</span>] =s[<span class="number">0</span>][<span class="number">1</span>], s[<span class="number">1</span>][<span class="number">1</span>], s[<span class="number">2</span>][<span class="number">1</span>], s[<span class="number">3</span>][<span class="number">1</span>]</span><br><span class="line">    s[<span class="number">2</span>][<span class="number">2</span>], s[<span class="number">3</span>][<span class="number">2</span>], s[<span class="number">0</span>][<span class="number">2</span>], s[<span class="number">1</span>][<span class="number">2</span>] =s[<span class="number">0</span>][<span class="number">2</span>], s[<span class="number">1</span>][<span class="number">2</span>], s[<span class="number">2</span>][<span class="number">2</span>], s[<span class="number">3</span>][<span class="number">2</span>]</span><br><span class="line">    s[<span class="number">3</span>][<span class="number">3</span>], s[<span class="number">0</span>][<span class="number">3</span>], s[<span class="number">1</span>][<span class="number">3</span>], s[<span class="number">2</span>][<span class="number">3</span>] =s[<span class="number">0</span>][<span class="number">3</span>], s[<span class="number">1</span>][<span class="number">3</span>], s[<span class="number">2</span>][<span class="number">3</span>], s[<span class="number">3</span>][<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">xtime = <span class="keyword">lambda</span> a: (((a &lt;&lt; <span class="number">1</span>) ^ <span class="number">0x1B</span>) &amp; <span class="number">0xFF</span>) <span class="keyword">if</span> (a &amp; <span class="number">0x80</span>) <span class="keyword">else</span> (a &lt;&lt; <span class="number">1</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mix_single_column</span>(<span class="params">a</span>):</span><br><span class="line">    <span class="comment"># see Sec 4.1.2 in The Design of Rijndael</span></span><br><span class="line">    t = a[<span class="number">0</span>] ^ a[<span class="number">1</span>] ^ a[<span class="number">2</span>] ^ a[<span class="number">3</span>]</span><br><span class="line">    u = a[<span class="number">0</span>]</span><br><span class="line">    a[<span class="number">0</span>] ^= t ^ xtime(a[<span class="number">0</span>] ^ a[<span class="number">1</span>])</span><br><span class="line">    a[<span class="number">1</span>] ^= t ^ xtime(a[<span class="number">1</span>] ^ a[<span class="number">2</span>])</span><br><span class="line">    a[<span class="number">2</span>] ^= t ^ xtime(a[<span class="number">2</span>] ^ a[<span class="number">3</span>])</span><br><span class="line">    a[<span class="number">3</span>] ^= t ^ xtime(a[<span class="number">3</span>] ^ u)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mix_columns</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        mix_single_column(s[i])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inv_mix_columns</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="comment"># see Sec 4.1.3 in The Design of Rijndael</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        u = xtime(xtime(s[i][<span class="number">0</span>] ^ s[i][<span class="number">2</span>]))</span><br><span class="line">        v = xtime(xtime(s[i][<span class="number">1</span>] ^ s[i][<span class="number">3</span>]))</span><br><span class="line">        s[i][<span class="number">0</span>] ^= u</span><br><span class="line">        s[i][<span class="number">1</span>] ^= v</span><br><span class="line">        s[i][<span class="number">2</span>] ^= u</span><br><span class="line">        s[i][<span class="number">3</span>] ^= v</span><br><span class="line"></span><br><span class="line">    mix_columns(s)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bytes2matrix</span>(<span class="params">text</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot; Converts a 16-byte array into a 4x4 matrix.  &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">list</span>(text[i:i+<span class="number">4</span>]) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(text), <span class="number">4</span>)]</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">matrix2bytes</span>(<span class="params">m</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(<span class="built_in">sum</span>(m,[]))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_round_key</span>(<span class="params">s, k</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">            s[i][j]^=k[i][j]</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inv_sub</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">            s[i][j] = inv_s_box[s[i][j]]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">expand_key</span>(<span class="params">master_key</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Expands and returns a list of key matrices for the given master_key.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># Round constants https://en.wikipedia.org/wiki/AES_key_schedule#Round_constants</span></span><br><span class="line">    r_con = (</span><br><span class="line">        <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x02</span>, <span class="number">0x04</span>, <span class="number">0x08</span>, <span class="number">0x10</span>, <span class="number">0x20</span>, <span class="number">0x40</span>,</span><br><span class="line">        <span class="number">0x80</span>, <span class="number">0x1B</span>, <span class="number">0x36</span>, <span class="number">0x6C</span>, <span class="number">0xD8</span>, <span class="number">0xAB</span>, <span class="number">0x4D</span>, <span class="number">0x9A</span>,</span><br><span class="line">        <span class="number">0x2F</span>, <span class="number">0x5E</span>, <span class="number">0xBC</span>, <span class="number">0x63</span>, <span class="number">0xC6</span>, <span class="number">0x97</span>, <span class="number">0x35</span>, <span class="number">0x6A</span>,</span><br><span class="line">        <span class="number">0xD4</span>, <span class="number">0xB3</span>, <span class="number">0x7D</span>, <span class="number">0xFA</span>, <span class="number">0xEF</span>, <span class="number">0xC5</span>, <span class="number">0x91</span>, <span class="number">0x39</span>,</span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># Initialize round keys with raw key material.</span></span><br><span class="line">    key_columns = bytes2matrix(master_key)</span><br><span class="line">    iteration_size = <span class="built_in">len</span>(master_key) // <span class="number">4</span></span><br><span class="line">    <span class="comment"># Each iteration has exactly as many columns as the key material.</span></span><br><span class="line">    columns_per_iteration = <span class="built_in">len</span>(key_columns)</span><br><span class="line">    i = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">len</span>(key_columns) &lt; (N_ROUNDS + <span class="number">1</span>) * <span class="number">4</span>:</span><br><span class="line">        <span class="comment"># Copy previous word.</span></span><br><span class="line">        word = <span class="built_in">list</span>(key_columns[-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Perform schedule_core once every &quot;row&quot;.</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(key_columns) % iteration_size == <span class="number">0</span>:</span><br><span class="line">            <span class="comment"># Circular shift.</span></span><br><span class="line">            word.append(word.pop(<span class="number">0</span>))</span><br><span class="line">            <span class="comment"># Map to S-BOX.</span></span><br><span class="line">            word = [s_box[b] <span class="keyword">for</span> b <span class="keyword">in</span> word]</span><br><span class="line">            <span class="comment"># XOR with first byte of R-CON, since the others bytes of R-CON are 0.</span></span><br><span class="line">            word[<span class="number">0</span>] ^= r_con[i]</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">len</span>(master_key) == <span class="number">32</span> <span class="keyword">and</span> <span class="built_in">len</span>(key_columns) % iteration_size == <span class="number">4</span>:</span><br><span class="line">            <span class="comment"># Run word through S-box in the fourth iteration when using a</span></span><br><span class="line">            <span class="comment"># 256-bit key.</span></span><br><span class="line">            word = [s_box[b] <span class="keyword">for</span> b <span class="keyword">in</span> word]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># XOR with equivalent word from previous iteration.</span></span><br><span class="line">        word = <span class="built_in">bytes</span>(i^j <span class="keyword">for</span> i, j <span class="keyword">in</span> <span class="built_in">zip</span>(word, key_columns[-iteration_size]))</span><br><span class="line">        key_columns.append(word)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Group key words in 4x4 byte matrices.</span></span><br><span class="line">    <span class="keyword">return</span> [key_columns[<span class="number">4</span>*i : <span class="number">4</span>*(i+<span class="number">1</span>)] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(key_columns) // <span class="number">4</span>)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">key, ciphertext</span>):</span><br><span class="line">    round_keys = expand_key(key) <span class="comment"># Remember to start from the last round key and work backwards through them when decrypting</span></span><br><span class="line">    <span class="comment"># Convert ciphertext to state matrix</span></span><br><span class="line">    Cipher_matrix = bytes2matrix(ciphertext)</span><br><span class="line">    <span class="comment"># Initial add round key step</span></span><br><span class="line">    add_round_key(Cipher_matrix,round_keys[-<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(N_ROUNDS - <span class="number">1</span>, <span class="number">0</span>, -<span class="number">1</span>):</span><br><span class="line">        inv_shift_rows(Cipher_matrix)</span><br><span class="line">        inv_sub(Cipher_matrix)</span><br><span class="line">        add_round_key(Cipher_matrix,round_keys[i])</span><br><span class="line">        inv_mix_columns(Cipher_matrix)</span><br><span class="line">    <span class="comment"># Run final round (skips the InvMixColumns step)</span></span><br><span class="line">    inv_shift_rows(Cipher_matrix)</span><br><span class="line">    inv_sub(Cipher_matrix)</span><br><span class="line">    add_round_key(Cipher_matrix,round_keys[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Convert state matrix to plaintext</span></span><br><span class="line">    plaintext = matrix2bytes(Cipher_matrix)</span><br><span class="line">    <span class="keyword">return</span> plaintext</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">key = <span class="string">b&#x27;Hello from 2048!&#x27;</span></span><br><span class="line">ciphertext = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;aeabcff64af98103ae8495303999da01357736e77c414d43efb0aa9b0127219c02e10e67c2bdfec2a397eaef65ed8b41&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;key:&quot;</span>,key)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;cipher:&quot;</span>,ciphertext.<span class="built_in">hex</span>())</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>()</span><br><span class="line">mm = <span class="string">b&#x27;&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;plaintext:&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">48</span>,<span class="number">16</span>):</span><br><span class="line">    <span class="built_in">print</span>(decrypt(key[:<span class="number">16</span>], ciphertext[i:i+<span class="number">16</span>]).<span class="built_in">hex</span>())</span><br></pre></td></tr></table></figure>

<h3 id="javascript"><a href="#javascript" class="headerlink" title="javascript"></a>javascript</h3><p>使用<a target="_blank" rel="noopener" href="http://www.dejs.vip/encry_decry/obfuscator.html">DeJS - js解密,js反混淆,js美化工具</a> 可以反混淆，但是部分函数会丢失循环内的代码。</p>
<p>关键函数在<code>checkseq</code>，传递到<code>docheck</code>的参数是kkk经过<code>kzlso</code>加密后的结果。</p>
<p><img src="https://s2.loli.net/2022/03/24/4ovec1GqV8LiT2f.png" alt="image-20220324152834706"></p>
<p><code>kzlso</code>调用的加密函数<code>ajsdhg</code>，可以看到TEA的常量。</p>
<p><img src="https://s2.loli.net/2022/03/24/fSa1MbgpN8LtDzV.png" alt="image-20220324152734490"></p>
<p>比赛时没有多想认为是XXTEA，复盘后发现是XTEA，痛失旅游机会x，XTEA的key可以扣出<code>kzlso</code>代码在控制台跑一遍得到。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span>  </span></span><br><span class="line">  </span><br><span class="line"><span class="comment">/* take 64 bits of data in v[0] and v[1] and 128 bits of key[0] - key[3] */</span>  </span><br><span class="line">  </span><br><span class="line"><span class="type">void</span> <span class="title function_">encipher</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> num_rounds, <span class="type">uint32_t</span> v[<span class="number">2</span>], <span class="type">uint32_t</span> <span class="type">const</span> key[<span class="number">4</span>])</span> &#123;  </span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> i;  </span><br><span class="line">    <span class="type">uint32_t</span> v0=v[<span class="number">0</span>], v1=v[<span class="number">1</span>], sum=<span class="number">0</span>, delta=<span class="number">0x9E3779B9</span>;  </span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i &lt; num_rounds; i++) &#123;  </span><br><span class="line">        v0 += (((v1 &lt;&lt; <span class="number">4</span>) ^ (v1 &gt;&gt; <span class="number">5</span>)) + v1) ^ (sum + key[sum &amp; <span class="number">3</span>]);  </span><br><span class="line">        sum += delta;  </span><br><span class="line">        v1 += (((v0 &lt;&lt; <span class="number">4</span>) ^ (v0 &gt;&gt; <span class="number">5</span>)) + v0) ^ (sum + key[(sum&gt;&gt;<span class="number">11</span>) &amp; <span class="number">3</span>]);  </span><br><span class="line">    &#125;  </span><br><span class="line">    v[<span class="number">0</span>]=v0; v[<span class="number">1</span>]=v1;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="type">void</span> <span class="title function_">decipher</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> num_rounds, <span class="type">uint32_t</span> v[<span class="number">2</span>], <span class="type">uint32_t</span> <span class="type">const</span> key[<span class="number">4</span>])</span> &#123;  </span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> i;  </span><br><span class="line">    <span class="type">uint32_t</span> v0=v[<span class="number">0</span>], v1=v[<span class="number">1</span>], delta=<span class="number">0x9E3779B9</span>, sum=delta*num_rounds;  </span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i &lt; num_rounds; i++) &#123;  </span><br><span class="line">        v1 -= (((v0 &lt;&lt; <span class="number">4</span>) ^ (v0 &gt;&gt; <span class="number">5</span>)) + v0) ^ (sum + key[(sum&gt;&gt;<span class="number">11</span>) &amp; <span class="number">3</span>]);  </span><br><span class="line">        sum -= delta;  </span><br><span class="line">        v0 -= (((v1 &lt;&lt; <span class="number">4</span>) ^ (v1 &gt;&gt; <span class="number">5</span>)) + v1) ^ (sum + key[sum &amp; <span class="number">3</span>]);  </span><br><span class="line">    &#125;  </span><br><span class="line">    v[<span class="number">0</span>]=v0; v[<span class="number">1</span>]=v1;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>  </span><br><span class="line">&#123;  </span><br><span class="line">    </span><br><span class="line">    <span class="type">uint32_t</span> <span class="type">const</span> k[<span class="number">4</span>] = &#123;<span class="number">745567528</span>,<span class="number">745567520</span>,<span class="number">2003788832</span>,<span class="number">1679830126</span>&#125;;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> r=<span class="number">32</span>;<span class="comment">//num_rounds建议取值为32  </span></span><br><span class="line">    <span class="comment">// v为要加密的数据是两个32位无符号整数  </span></span><br><span class="line">    <span class="comment">// k为加密解密密钥，为4个32位无符号整数，即密钥长度为128位  </span></span><br><span class="line">    <span class="type">uint32_t</span> out [] =&#123;<span class="number">0x1c7ef2c3</span>,<span class="number">0x9184c02d</span>,<span class="number">0xb70d2426</span>,<span class="number">0x58a84fef</span>,<span class="number">0x467849cd</span>,<span class="number">0xf8594a66</span>,<span class="number">0xa06495b6</span>,<span class="number">0xd506cf2b</span>,<span class="number">0x5fde32ab</span>,<span class="number">0x6ba8ff9b</span>,<span class="number">0xad3f12af</span>,<span class="number">0x28c1575d</span>,&#125;;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i =<span class="number">0</span>;i&lt;<span class="number">12</span>;i+=<span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">       <span class="type">uint32_t</span> v[<span class="number">2</span>]=&#123; out[i],out[i+<span class="number">1</span>]&#125;;</span><br><span class="line"></span><br><span class="line">       decipher(r, v, k);  </span><br><span class="line">       <span class="built_in">printf</span>(<span class="string">&quot;%08x %08x\n&quot;</span>,v[<span class="number">0</span>],v[<span class="number">1</span>]);  </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>flag{6dcdac98075f11316af7a239c9ddfe47}</p>
</blockquote>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Reverse/">Reverse</a><a class="post-meta__tags" href="/tags/CTF/">CTF</a><a class="post-meta__tags" href="/tags/WriteUp/">WriteUp</a></div><div class="post_share"></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/02/19/Life/ES%E5%B0%8F%E4%B8%BB%E6%9C%BA%E6%8A%98%E8%85%BE%E8%AE%B0/" title="ES小主机折腾记"><img class="cover" src="https://s2.loli.net/2024/02/19/kctqJ6bRvNTnBej.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">ES小主机折腾记</div></div></a></div><div class="next-post pull-right"><a href="/2022/03/09/WriteUp/%E7%AE%80%E7%AE%80%E5%8D%95%E5%8D%95%E5%AF%86%E7%A0%81%E9%A2%98/" title="简简单单密码题"><img class="cover" src="https://s2.loli.net/2024/02/20/i5askw6xYVRKDtE.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">简简单单密码题</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://s2.loli.net/2024/05/04/Zav4zFVukLJMBKI.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">devoke</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">19</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">17</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">2</div></a></div></div><div class="sticky_layout"><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/03/03/Reverse/lighthouse%20%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/" title="lighthouse 使用指南">lighthouse 使用指南</a><time datetime="2024-03-03T15:45:14.000Z" title="发表于 2024-03-03 23:45:14">2024-03-03</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/02/19/Life/ES%E5%B0%8F%E4%B8%BB%E6%9C%BA%E6%8A%98%E8%85%BE%E8%AE%B0/" title="ES小主机折腾记">ES小主机折腾记</a><time datetime="2024-02-19T03:05:01.000Z" title="发表于 2024-02-19 11:05:01">2024-02-19</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/03/20/WriteUp/HFCTF2022-RE/" title="HFCTF2022 RE">HFCTF2022 RE</a><time datetime="2022-03-20T12:04:53.000Z" title="发表于 2022-03-20 20:04:53">2022-03-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/03/09/WriteUp/%E7%AE%80%E7%AE%80%E5%8D%95%E5%8D%95%E5%AF%86%E7%A0%81%E9%A2%98/" title="简简单单密码题">简简单单密码题</a><time datetime="2022-03-09T12:08:44.000Z" title="发表于 2022-03-09 20:08:44">2022-03-09</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/02/03/Python/Python-multiprocess-learning/" title="Python multiprocess learning">Python multiprocess learning</a><time datetime="2022-02-03T06:25:30.000Z" title="发表于 2022-02-03 14:25:30">2022-02-03</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://s2.loli.net/2024/02/20/h3iOcSdRqel45vD.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By devoke</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/"></script><script src="/"></script><script src="/"></script><div class="js-pjax"></div></div></body></html>